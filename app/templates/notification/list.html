{% extends "base.html" %}

{% block title %}é€šçŸ¥æ¶ˆæ¯ - ç”µå•†å¹³å°ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="card">
    <h2>ğŸ”” é€šçŸ¥æ¶ˆæ¯</h2>
    
    <div class="search-bar">
        <select id="isReadFilter" onchange="filterNotifications()">
            <option value="-1" {% if is_read == -1 %}selected{% endif %}>å…¨éƒ¨</option>
            <option value="0" {% if is_read == 0 %}selected{% endif %}>æœªè¯»</option>
            <option value="1" {% if is_read == 1 %}selected{% endif %}>å·²è¯»</option>
        </select>
        <button class="btn btn-primary" onclick="markAllRead()">å…¨éƒ¨æ ‡è®°ä¸ºå·²è¯»</button>
    </div>
    
    <table>
        <thead>
            <tr>
                <th width="60">çŠ¶æ€</th>
                <th>æ ‡é¢˜</th>
                <th>å†…å®¹</th>
                <th>ç±»å‹</th>
                <th>æ—¶é—´</th>
                <th width="100">æ“ä½œ</th>
            </tr>
        </thead>
        <tbody>
            {% for notification in notifications %}
            <tr style="{% if notification.is_read == 0 %}background: #f5f7ff;{% endif %}">
                <td>
                    {% if notification.is_read == 0 %}
                    <span class="badge badge-warning">æœªè¯»</span>
                    {% else %}
                    <span class="badge badge-info">å·²è¯»</span>
                    {% endif %}
                </td>
                <td><strong>{{ notification.title }}</strong></td>
                <td>{{ notification.content[:100] }}{% if notification.content|length > 100 %}...{% endif %}</td>
                <td>
                    {% if notification.type == 1 %}
                    <span class="badge badge-info">ç³»ç»Ÿ</span>
                    {% elif notification.type == 2 %}
                    <span class="badge badge-success">è®¢å•</span>
                    {% elif notification.type == 3 %}
                    <span class="badge badge-warning">é…ç½®</span>
                    {% elif notification.type == 4 %}
                    <span class="badge badge-danger">è­¦å‘Š</span>
                    {% endif %}
                </td>
                <td>{{ notification.create_time.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                <td>
                    {% if notification.is_read == 0 %}
                    <button class="btn btn-primary" onclick="markRead({{ notification.id }})">æ ‡è®°å·²è¯»</button>
                    {% else %}
                    -
                    {% endif %}
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="6" style="text-align: center; color: #999;">æš‚æ— æ¶ˆæ¯</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    {% if pagination.pages > 1 %}
    <div class="pagination">
        {% if pagination.has_prev %}
        <a href="?page={{ pagination.prev_num }}&is_read={{ is_read }}">ä¸Šä¸€é¡µ</a>
        {% endif %}
        
        {% for page_num in pagination.iter_pages(left_edge=2, right_edge=2, left_current=2, right_current=2) %}
            {% if page_num %}
                <a href="?page={{ page_num }}&is_read={{ is_read }}" 
                   class="{% if page_num == pagination.page %}active{% endif %}">
                    {{ page_num }}
                </a>
            {% else %}
                <span>...</span>
            {% endif %}
        {% endfor %}
        
        {% if pagination.has_next %}
        <a href="?page={{ pagination.next_num }}&is_read={{ is_read }}">ä¸‹ä¸€é¡µ</a>
        {% endif %}
    </div>
    {% endif %}
</div>

<script>
    function filterNotifications() {
        const isRead = document.getElementById('isReadFilter').value;
        window.location.href = '?is_read=' + isRead;
    }
    
    function markRead(notificationId) {
        const formData = new FormData();
        formData.append('notification_id', notificationId);
        
        fetch('/notification/mark-read', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            showToast(data.message, data.success ? 'success' : 'error');
            if (data.success) {
                setTimeout(() => location.reload(), 500);
            }
        })
        .catch(error => {
            showToast('æ“ä½œå¤±è´¥', 'error');
        });
    }
    
    function markAllRead() {
        if (!confirm('ç¡®å®šè¦å°†æ‰€æœ‰æ¶ˆæ¯æ ‡è®°ä¸ºå·²è¯»å—ï¼Ÿ')) return;
        
        fetch('/notification/mark-all-read', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            showToast(data.message, data.success ? 'success' : 'error');
            if (data.success) {
                setTimeout(() => location.reload(), 1000);
            }
        })
        .catch(error => {
            showToast('æ“ä½œå¤±è´¥', 'error');
        });
    }
</script>
{% endblock %}
