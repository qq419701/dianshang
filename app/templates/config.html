{% extends "base.html" %}
{% block title %}ç³»ç»Ÿé…ç½® â€” ç”µå•†å¹³å°ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block content %}
<h2 style="margin-bottom: 20px; font-size: 20px;">âš™ï¸ ç³»ç»Ÿé…ç½®</h2>

<!-- æ¥å£åœ°å€ç”Ÿæˆå™¨ -->
<div class="card">
    <h2>ğŸ”— æ¥å£åœ°å€ç”Ÿæˆå™¨</h2>
    <p style="font-size: 13px; color: #666; margin-bottom: 12px;">
        è¾“å…¥æ‚¨çš„åŸŸåï¼Œè‡ªåŠ¨ç”Ÿæˆéœ€è¦æäº¤ç»™äº¬ä¸œçš„æ‰€æœ‰æ¥å£åœ°å€
    </p>
    <div style="display: flex; gap: 12px; align-items: center;">
        <input type="text" id="domainInput" placeholder="ä¾‹å¦‚ï¼šhttps://yourdomain.com"
               style="flex: 1; padding: 8px 12px; border: 1px solid #d0d5dd; border-radius: 6px;">
        <button class="btn btn-primary" onclick="generateUrls()">ç”Ÿæˆåœ°å€</button>
    </div>
    <div id="urlResult" style="margin-top: 16px; display: none;">
        <h3 style="font-size: 14px; margin: 12px 0 8px;">äº¬ä¸œé€šç”¨äº¤æ˜“æ¥å£åœ°å€ï¼š</h3>
        <ul class="url-list" id="generalUrls"></ul>
        <h3 style="font-size: 14px; margin: 12px 0 8px;">äº¬ä¸œæ¸¸æˆç‚¹å¡æ¥å£åœ°å€ï¼š</h3>
        <ul class="url-list" id="gameUrls"></ul>
    </div>
</div>

<!-- é…ç½®é€‰é¡¹å¡ -->
<div class="tabs">
    <div class="tab active" onclick="switchTab('tab-general', event)">äº¬ä¸œé€šç”¨äº¤æ˜“é…ç½®</div>
    <div class="tab" onclick="switchTab('tab-game', event)">äº¬ä¸œæ¸¸æˆç‚¹å¡é…ç½®</div>
    <div class="tab" onclick="switchTab('tab-agiso', event)">é˜¿å¥‡ç´¢å¼€æ”¾å¹³å°é…ç½®</div>
</div>

<!-- äº¬ä¸œé€šç”¨äº¤æ˜“é…ç½® -->
<div class="tab-content active" id="tab-general">
    <div class="card">
        <h2>äº¬ä¸œé€šç”¨äº¤æ˜“å¹³å°é…ç½®</h2>
        <form id="generalForm">
            <input type="hidden" name="config_type" value="general">
            <input type="hidden" name="merchant_id" value="{{ merchant_id }}">

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                <div class="form-group">
                    <label>å•†å®¶IDï¼ˆvendorIdï¼‰</label>
                    <input type="number" name="vendor_id"
                           value="{{ general_config.vendor_id if general_config else '' }}"
                           placeholder="äº¬ä¸œåˆ†é…çš„å•†å®¶å”¯ä¸€ç¼–å·">
                </div>
                <div class="form-group">
                    <label>MD5ç­¾åå¯†é’¥</label>
                    <input type="password" name="md5_secret"
                           value="{{ '******' if general_config and general_config.md5_secret else '' }}"
                           placeholder="ç­¾åç§é’¥">
                </div>
                <div class="form-group">
                    <label>AESåŠ å¯†å¯†é’¥ï¼ˆ32å­—èŠ‚ï¼‰</label>
                    <input type="password" name="aes_secret"
                           value="{{ '******' if general_config and general_config.aes_secret else '' }}"
                           placeholder="å¡å¯†åŠ å¯†å¯†é’¥ï¼Œå¿…é¡»32å­—èŠ‚">
                </div>
                <div class="form-group">
                    <label>æˆ‘æ–¹æ¥å£åŸºç¡€åœ°å€</label>
                    <input type="url" name="our_api_url"
                           value="{{ general_config.our_api_url if general_config else '' }}"
                           placeholder="ä¾‹å¦‚ï¼šhttps://yourdomain.com">
                </div>
                <div class="form-group">
                    <label>äº¬ä¸œå›è°ƒåœ°å€</label>
                    <input type="url" name="jd_callback_url"
                           value="{{ general_config.jd_callback_url if general_config else '' }}"
                           placeholder="æµ‹è¯•ï¼šhttps://tsp.shop.jd.com/vtp/produce/notify">
                </div>
                <div class="form-group">
                    <label>å¯ç”¨çŠ¶æ€</label>
                    <select name="is_enabled">
                        <option value="1" {% if general_config and general_config.is_enabled == 1 %}selected{% endif %}>å¯ç”¨</option>
                        <option value="0" {% if general_config and general_config.is_enabled == 0 %}selected{% endif %}>ç¦ç”¨</option>
                    </select>
                </div>
            </div>
            <button type="button" class="btn btn-success" onclick="saveConfig('generalForm')" style="margin-top: 8px;">
                ğŸ’¾ ä¿å­˜é…ç½®
            </button>
        </form>
    </div>
</div>

<!-- äº¬ä¸œæ¸¸æˆç‚¹å¡é…ç½® -->
<div class="tab-content" id="tab-game">
    <div class="card">
        <h2>äº¬ä¸œæ¸¸æˆç‚¹å¡å¹³å°é…ç½®</h2>
        <form id="gameForm">
            <input type="hidden" name="config_type" value="game">
            <input type="hidden" name="merchant_id" value="{{ merchant_id }}">

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                <div class="form-group">
                    <label>åˆä½œå•†ç¼–å·ï¼ˆcustomerIdï¼‰</label>
                    <input type="number" name="customer_id"
                           value="{{ game_config.customer_id if game_config else '' }}"
                           placeholder="äº¬ä¸œåˆ†é…çš„åˆä½œå•†ç¼–å·">
                </div>
                <div class="form-group">
                    <label>MD5ç­¾åç§é’¥</label>
                    <input type="password" name="md5_secret"
                           value="{{ '******' if game_config and game_config.md5_secret else '' }}"
                           placeholder="ç­¾åç§é’¥">
                </div>
                <div class="form-group">
                    <label>æˆ‘æ–¹æ¥å£åŸºç¡€åœ°å€</label>
                    <input type="url" name="our_api_url"
                           value="{{ game_config.our_api_url if game_config else '' }}"
                           placeholder="ä¾‹å¦‚ï¼šhttps://yourdomain.com">
                </div>
                <div class="form-group">
                    <label>ç›´å……å›è°ƒåœ°å€</label>
                    <input type="url" name="jd_direct_callback_url"
                           value="{{ game_config.jd_direct_callback_url if game_config else 'https://card.jd.com/api/gameApi.action' }}"
                           placeholder="æ­£å¼ï¼šhttps://card.jd.com/api/gameApi.action">
                </div>
                <div class="form-group">
                    <label>å¡å¯†å›è°ƒåœ°å€</label>
                    <input type="url" name="jd_card_callback_url"
                           value="{{ game_config.jd_card_callback_url if game_config else 'https://card.jd.com/api/cardApi.action' }}"
                           placeholder="æ­£å¼ï¼šhttps://card.jd.com/api/cardApi.action">
                </div>
                <div class="form-group">
                    <label>å¯ç”¨çŠ¶æ€</label>
                    <select name="is_enabled">
                        <option value="1" {% if game_config and game_config.is_enabled == 1 %}selected{% endif %}>å¯ç”¨</option>
                        <option value="0" {% if game_config and game_config.is_enabled == 0 %}selected{% endif %}>ç¦ç”¨</option>
                    </select>
                </div>
            </div>
            <button type="button" class="btn btn-success" onclick="saveConfig('gameForm')" style="margin-top: 8px;">
                ğŸ’¾ ä¿å­˜é…ç½®
            </button>
        </form>
    </div>
</div>

<!-- é˜¿å¥‡ç´¢å¼€æ”¾å¹³å°é…ç½® -->
<div class="tab-content" id="tab-agiso">
    <div class="card">
        <h2>é˜¿å¥‡ç´¢å¼€æ”¾å¹³å°é…ç½®ï¼ˆå¯é€‰æ¨¡å—ï¼‰</h2>
        <p style="font-size: 13px; color: #999; margin-bottom: 16px;">
            âš ï¸ æ­¤æ¨¡å—ä¸ºå¯é€‰åŠŸèƒ½ã€‚æœªé…ç½®æ—¶ä¸å½±å“ä¸»æµç¨‹ï¼Œè®¢å•é¡µ"é˜¿å¥‡ç´¢è‡ªåŠ¨å‘è´§"æŒ‰é’®å°†è‡ªåŠ¨éšè—ã€‚
        </p>
        <form id="agisoForm">
            <input type="hidden" name="config_type" value="agiso">
            <input type="hidden" name="merchant_id" value="{{ merchant_id }}">

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                <div class="form-group">
                    <label>APIç½‘å…³åœ°å€</label>
                    <input type="url" name="host"
                           value="{{ agiso_config.host if agiso_config else 'https://open.agiso.com' }}"
                           placeholder="https://open.agiso.com">
                </div>
                <div class="form-group">
                    <label>ç«¯å£</label>
                    <input type="number" name="port"
                           value="{{ agiso_config.port if agiso_config else '' }}"
                           placeholder="é»˜è®¤ä¸å¡«">
                </div>
                <div class="form-group">
                    <label>åº”ç”¨IDï¼ˆAppIdï¼‰</label>
                    <input type="text" name="app_id"
                           value="{{ agiso_config.app_id if agiso_config else '' }}"
                           placeholder="åœ¨é˜¿å¥‡ç´¢å¼€æ”¾å¹³å°åˆ›å»ºåº”ç”¨åè·å–">
                </div>
                <div class="form-group">
                    <label>åº”ç”¨å¯†é’¥ï¼ˆAppSecretï¼‰</label>
                    <input type="password" name="app_secret"
                           value="{{ '******' if agiso_config and agiso_config.app_secret else '' }}"
                           placeholder="åº”ç”¨å¯†é’¥">
                </div>
                <div class="form-group">
                    <label>æˆæƒä»¤ç‰Œï¼ˆAccessTokenï¼‰</label>
                    <input type="password" name="access_token"
                           value="{{ '******' if agiso_config and agiso_config.access_token else '' }}"
                           placeholder="åº—é“ºæˆæƒåè·å–çš„Token">
                </div>
                <div class="form-group">
                    <label>é€šç”¨äº¤æ˜“è·¯ç”±</label>
                    <input type="text" name="general_trade_route"
                           value="{{ agiso_config.general_trade_route if agiso_config else '' }}"
                           placeholder="é€šç”¨äº¤æ˜“è·¯ç”±è·¯å¾„">
                </div>
                <div class="form-group">
                    <label>ç‚¹å¡è·¯ç”±</label>
                    <input type="text" name="game_card_route"
                           value="{{ agiso_config.game_card_route if agiso_config else '' }}"
                           placeholder="æ¸¸æˆç‚¹å¡è·¯ç”±è·¯å¾„">
                </div>
                <div class="form-group">
                    <label>å¯ç”¨çŠ¶æ€</label>
                    <select name="is_enabled">
                        <option value="0" {% if not agiso_config or agiso_config.is_enabled == 0 %}selected{% endif %}>ç¦ç”¨</option>
                        <option value="1" {% if agiso_config and agiso_config.is_enabled == 1 %}selected{% endif %}>å¯ç”¨</option>
                    </select>
                </div>
            </div>
            <button type="button" class="btn btn-success" onclick="saveConfig('agisoForm')" style="margin-top: 8px;">
                ğŸ’¾ ä¿å­˜é…ç½®
            </button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    /**
     * ç”Ÿæˆæ¥å£åœ°å€
     * è¾“å…¥åŸŸååè‡ªåŠ¨ç”Ÿæˆæ‰€æœ‰éœ€è¦æäº¤ç»™äº¬ä¸œçš„æ¥å£åœ°å€
     */
    function generateUrls() {
        var domain = document.getElementById('domainInput').value.trim();
        if (!domain) {
            showToast('è¯·è¾“å…¥åŸŸå', 'error');
            return;
        }

        var formData = new FormData();
        formData.append('domain', domain);

        fetch('/admin/generate-urls', { method: 'POST', body: formData })
            .then(function(resp) { return resp.json(); })
            .then(function(data) {
                if (data.success) {
                    var generalHtml = '';
                    for (var key in data.data.general) {
                        generalHtml += '<li><strong>' + key + 'ï¼š</strong><code>' + data.data.general[key] + '</code></li>';
                    }
                    document.getElementById('generalUrls').innerHTML = generalHtml;

                    var gameHtml = '';
                    for (var key2 in data.data.game) {
                        gameHtml += '<li><strong>' + key2 + 'ï¼š</strong><code>' + data.data.game[key2] + '</code></li>';
                    }
                    document.getElementById('gameUrls').innerHTML = gameHtml;

                    document.getElementById('urlResult').style.display = 'block';
                    showToast('æ¥å£åœ°å€ç”ŸæˆæˆåŠŸ', 'success');
                } else {
                    showToast(data.message, 'error');
                }
            })
            .catch(function() { showToast('è¯·æ±‚å¤±è´¥', 'error'); });
    }

    /**
     * ä¿å­˜é…ç½®
     * å°†è¡¨å•æ•°æ®æäº¤åˆ°åç«¯ä¿å­˜
     * @param {string} formId - è¡¨å•å…ƒç´ ID
     */
    function saveConfig(formId) {
        var form = document.getElementById(formId);
        var formData = new FormData(form);

        fetch('/admin/config/save', { method: 'POST', body: formData })
            .then(function(resp) { return resp.json(); })
            .then(function(data) {
                if (data.success) {
                    showToast('é…ç½®ä¿å­˜æˆåŠŸ', 'success');
                } else {
                    showToast(data.message || 'ä¿å­˜å¤±è´¥', 'error');
                }
            })
            .catch(function() { showToast('è¯·æ±‚å¤±è´¥', 'error'); });
    }
</script>
{% endblock %}
