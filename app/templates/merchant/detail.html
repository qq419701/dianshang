{% extends "base.html" %}

{% block title %}å•†æˆ·è¯¦æƒ… - {{ merchant.name }} - ç”µå•†å¹³å°ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="card">
    <h2>ğŸ¢ å•†æˆ·ä¿¡æ¯ - {{ merchant.name }}</h2>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-top: 16px;">
        <div><strong>å•†æˆ·åç§°ï¼š</strong>{{ merchant.name }}</div>
        <div><strong>å•†æˆ·ä»£ç ï¼š</strong>{{ merchant.code or '-' }}</div>
        <div><strong>è”ç³»äººï¼š</strong>{{ merchant.contact_name or '-' }}</div>
        <div><strong>è”ç³»æ‰‹æœºï¼š</strong>{{ merchant.contact_mobile or '-' }}</div>
        <div><strong>è”ç³»é‚®ç®±ï¼š</strong>{{ merchant.contact_email or '-' }}</div>
        <div><strong>çŠ¶æ€ï¼š</strong>
            {% if merchant.status == 1 %}
            <span class="badge badge-success">æ­£å¸¸</span>
            {% else %}
            <span class="badge badge-danger">ç¦ç”¨</span>
            {% endif %}
        </div>
    </div>
</div>

<div class="card">
    <h2>ğŸª åº—é“ºç®¡ç†</h2>
    <div style="margin-bottom: 16px;">
        <button class="btn btn-success" onclick="showCreateShopModal()">+ æ–°å¢åº—é“º</button>
        <button class="btn btn-primary" onclick="location.href='/statistics/?merchant_id={{ merchant.id }}'">æŸ¥çœ‹ç»Ÿè®¡</button>
    </div>
    
    <table>
        <thead>
            <tr>
                <th>åº—é“ºID</th>
                <th>åº—é“ºåç§°</th>
                <th>åº—é“ºç¼–ç </th>
                <th>ä¸šåŠ¡ç±»å‹</th>
                <th>è®¢å•æ•°</th>
                <th>é…ç½®çŠ¶æ€</th>
                <th>å¯ç”¨çŠ¶æ€</th>
                <th>æ“ä½œ</th>
            </tr>
        </thead>
        <tbody id="shopList">
            <tr>
                <td colspan="8" style="text-align: center; color: #999;">åŠ è½½ä¸­...</td>
            </tr>
        </tbody>
    </table>
</div>

<!-- æ–°å¢/ç¼–è¾‘åº—é“ºæ¨¡æ€æ¡† -->
<div id="shopModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; overflow-y: auto;">
    <div style="position: relative; top: 20px; margin: 0 auto 40px; background: #fff; padding: 30px; border-radius: 8px; width: 600px; max-width: 90%;">
        <h3 id="shopModalTitle">æ–°å¢åº—é“º</h3>
        <form id="shopForm">
            <input type="hidden" id="shopId">
            <input type="hidden" id="merchantId" value="{{ merchant.id }}">
            
            <div class="form-group">
                <label>åº—é“ºåç§° *</label>
                <input type="text" id="shopName" required>
            </div>
            
            <div class="form-group">
                <label>åº—é“ºç¼–ç </label>
                <input type="text" id="shopCode">
            </div>
            
            <div class="form-group">
                <label>ä¸šåŠ¡ç±»å‹ *</label>
                <select id="bizType" onchange="toggleBizTypeFields()" required>
                    <option value="">è¯·é€‰æ‹©</option>
                    <option value="1">äº¬ä¸œé€šç”¨äº¤æ˜“</option>
                    <option value="2">äº¬ä¸œæ¸¸æˆç‚¹å¡</option>
                </select>
            </div>
            
            <!-- é€šç”¨äº¤æ˜“å­—æ®µ -->
            <div id="generalFields" style="display: none;">
                <div class="form-group">
                    <label>Vendor ID *</label>
                    <input type="number" id="vendorId">
                </div>
                <div class="form-group">
                    <label>äº¬ä¸œå›è°ƒåœ°å€</label>
                    <input type="text" id="jdCallbackUrl">
                </div>
            </div>
            
            <!-- æ¸¸æˆç‚¹å¡å­—æ®µ -->
            <div id="gameFields" style="display: none;">
                <div class="form-group">
                    <label>Customer ID *</label>
                    <input type="number" id="customerId">
                </div>
                <div class="form-group">
                    <label>äº¬ä¸œç›´å……å›è°ƒåœ°å€</label>
                    <input type="text" id="jdDirectCallbackUrl">
                </div>
                <div class="form-group">
                    <label>äº¬ä¸œå¡å¯†å›è°ƒåœ°å€</label>
                    <input type="text" id="jdCardCallbackUrl">
                </div>
            </div>
            
            <!-- å…¬å…±å­—æ®µ -->
            <div class="form-group">
                <label>æˆ‘æ–¹æ¥å£åœ°å€</label>
                <input type="text" id="ourApiUrl">
            </div>
            
            <div class="form-group">
                <label>MD5å¯†é’¥</label>
                <input type="text" id="md5Secret" placeholder="ç•™ç©ºåˆ™ä¸ä¿®æ”¹">
            </div>
            
            <div class="form-group">
                <label>AESå¯†é’¥</label>
                <input type="text" id="aesSecret" placeholder="ç•™ç©ºåˆ™ä¸ä¿®æ”¹">
            </div>
            
            <div class="form-group">
                <label>å¤‡æ³¨</label>
                <textarea id="remark" rows="2"></textarea>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="submit" class="btn btn-primary" style="flex: 1;">ä¿å­˜</button>
                <button type="button" class="btn btn-secondary" onclick="closeShopModal()" style="flex: 1;">å–æ¶ˆ</button>
            </div>
        </form>
    </div>
</div>

<script>
const merchantId = {{ merchant.id }};

// é¡µé¢åŠ è½½æ—¶è·å–åº—é“ºåˆ—è¡¨
loadShops();

function loadShops() {
    fetch('/shop/list/' + merchantId)
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                renderShops(data.data);
            } else {
                showToast('åŠ è½½å¤±è´¥', 'error');
            }
        })
        .catch(err => {
            console.error(err);
            showToast('åŠ è½½å¤±è´¥', 'error');
        });
}

function renderShops(shops) {
    const tbody = document.getElementById('shopList');
    if (shops.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #999;">æš‚æ— åº—é“º</td></tr>';
        return;
    }
    
    tbody.innerHTML = shops.map(shop => `
        <tr>
            <td>${shop.id}</td>
            <td>${shop.shop_name}</td>
            <td>${shop.shop_code || '-'}</td>
            <td>${shop.biz_type_name}</td>
            <td>${shop.order_count}</td>
            <td>${shop.config_complete ? '<span class="badge badge-success">å®Œæ•´</span>' : '<span class="badge badge-warning">ä¸å®Œæ•´</span>'}</td>
            <td>${shop.is_enabled ? '<span class="badge badge-success">å¯ç”¨</span>' : '<span class="badge badge-danger">ç¦ç”¨</span>'}</td>
            <td>
                <button class="btn btn-primary" onclick="editShop(${shop.id})">ç¼–è¾‘</button>
                <button class="btn btn-danger" onclick="deleteShop(${shop.id})">åˆ é™¤</button>
            </td>
        </tr>
    `).join('');
}

function showCreateShopModal() {
    document.getElementById('shopModalTitle').textContent = 'æ–°å¢åº—é“º';
    document.getElementById('shopForm').reset();
    document.getElementById('shopId').value = '';
    document.getElementById('merchantId').value = merchantId;
    toggleBizTypeFields();
    document.getElementById('shopModal').style.display = 'block';
}

function editShop(shopId) {
    fetch('/shop/detail/' + shopId)
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                const shop = data.data;
                document.getElementById('shopModalTitle').textContent = 'ç¼–è¾‘åº—é“º';
                document.getElementById('shopId').value = shop.id;
                document.getElementById('shopName').value = shop.shop_name;
                document.getElementById('shopCode').value = shop.shop_code || '';
                document.getElementById('bizType').value = shop.biz_type;
                document.getElementById('ourApiUrl').value = shop.our_api_url || '';
                document.getElementById('remark').value = shop.remark || '';
                
                if (shop.biz_type == 1) {
                    document.getElementById('vendorId').value = shop.vendor_id || '';
                    document.getElementById('jdCallbackUrl').value = shop.jd_callback_url || '';
                } else if (shop.biz_type == 2) {
                    document.getElementById('customerId').value = shop.customer_id || '';
                    document.getElementById('jdDirectCallbackUrl').value = shop.jd_direct_callback_url || '';
                    document.getElementById('jdCardCallbackUrl').value = shop.jd_card_callback_url || '';
                }
                
                toggleBizTypeFields();
                document.getElementById('shopModal').style.display = 'block';
            }
        })
        .catch(err => showToast('åŠ è½½å¤±è´¥', 'error'));
}

function closeShopModal() {
    document.getElementById('shopModal').style.display = 'none';
}

function toggleBizTypeFields() {
    const bizType = document.getElementById('bizType').value;
    document.getElementById('generalFields').style.display = bizType == '1' ? 'block' : 'none';
    document.getElementById('gameFields').style.display = bizType == '2' ? 'block' : 'none';
}

function deleteShop(shopId) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¯¥åº—é“ºå—ï¼Ÿ')) return;
    
    fetch('/shop/delete/' + shopId, { method: 'POST' })
        .then(res => res.json())
        .then(data => {
            showToast(data.message, data.success ? 'success' : 'error');
            if (data.success) loadShops();
        })
        .catch(err => showToast('æ“ä½œå¤±è´¥', 'error'));
}

document.getElementById('shopForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const shopId = document.getElementById('shopId').value;
    const bizType = document.getElementById('bizType').value;
    
    const data = {
        merchant_id: merchantId,
        shop_name: document.getElementById('shopName').value,
        shop_code: document.getElementById('shopCode').value,
        biz_type: bizType,
        our_api_url: document.getElementById('ourApiUrl').value,
        md5_secret: document.getElementById('md5Secret').value,
        aes_secret: document.getElementById('aesSecret').value,
        remark: document.getElementById('remark').value
    };
    
    if (bizType == '1') {
        data.vendor_id = document.getElementById('vendorId').value;
        data.jd_callback_url = document.getElementById('jdCallbackUrl').value;
    } else if (bizType == '2') {
        data.customer_id = document.getElementById('customerId').value;
        data.jd_direct_callback_url = document.getElementById('jdDirectCallbackUrl').value;
        data.jd_card_callback_url = document.getElementById('jdCardCallbackUrl').value;
    }
    
    const url = shopId ? '/shop/update/' + shopId : '/shop/create';
    
    fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(result => {
        showToast(result.message, result.success ? 'success' : 'error');
        if (result.success) {
            closeShopModal();
            loadShops();
        }
    })
    .catch(err => showToast('æ“ä½œå¤±è´¥', 'error'));
});
</script>
{% endblock %}
