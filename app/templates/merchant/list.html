{% extends "base.html" %}

{% block title %}å•†æˆ·ç®¡ç† - ç”µå•†å¹³å°ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="card">
    <h2>ğŸ¢ å•†æˆ·ç®¡ç†</h2>
    
    <div class="search-bar">
        <input type="text" id="searchInput" placeholder="æœç´¢å•†æˆ·åç§°/ä»£ç " value="{{ search }}">
        <button class="btn btn-primary" onclick="searchMerchants()">æœç´¢</button>
        <button class="btn btn-success" onclick="showCreateModal()">æ–°å¢å•†æˆ·</button>
    </div>
    
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>å•†æˆ·åç§°</th>
                <th>å•†æˆ·ä»£ç </th>
                <th>åº—é“ºæ•°é‡</th>
                <th>è”ç³»äºº</th>
                <th>è”ç³»æ‰‹æœº</th>
                <th>çŠ¶æ€</th>
                <th>åˆ›å»ºæ—¶é—´</th>
                <th>æ“ä½œ</th>
            </tr>
        </thead>
        <tbody>
            {% for item in merchants %}
            <tr>
                <td>{{ item.merchant.id }}</td>
                <td>{{ item.merchant.name }}</td>
                <td>{{ item.merchant.code or '-' }}</td>
                <td>{{ item.shop_count }}</td>
                <td>{{ item.merchant.contact_name or '-' }}</td>
                <td>{{ item.merchant.contact_mobile or '-' }}</td>
                <td>
                    {% if item.merchant.status == 1 %}
                    <span class="badge badge-success">æ­£å¸¸</span>
                    {% else %}
                    <span class="badge badge-danger">ç¦ç”¨</span>
                    {% endif %}
                </td>
                <td>{{ item.merchant.create_time.strftime('%Y-%m-%d %H:%M') }}</td>
                <td>
                    <button class="btn btn-primary" onclick="location.href='/merchant/detail/{{ item.merchant.id }}'">æŸ¥çœ‹åº—é“º</button>
                    <button class="btn btn-primary" onclick="editMerchant({{ item.merchant.id }})">ç¼–è¾‘</button>
                    <button class="btn btn-danger" onclick="deleteMerchant({{ item.merchant.id }})">åˆ é™¤</button>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="9" style="text-align: center; color: #999;">æš‚æ— æ•°æ®</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    {% if pagination.pages > 1 %}
    <div class="pagination">
        {% if pagination.has_prev %}
        <a href="?page={{ pagination.prev_num }}&search={{ search }}">ä¸Šä¸€é¡µ</a>
        {% endif %}
        
        {% for page_num in pagination.iter_pages(left_edge=2, right_edge=2, left_current=2, right_current=2) %}
            {% if page_num %}
                <a href="?page={{ page_num }}&search={{ search }}" 
                   class="{% if page_num == pagination.page %}active{% endif %}">
                    {{ page_num }}
                </a>
            {% else %}
                <span>...</span>
            {% endif %}
        {% endfor %}
        
        {% if pagination.has_next %}
        <a href="?page={{ pagination.next_num }}&search={{ search }}">ä¸‹ä¸€é¡µ</a>
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- æ–°å¢/ç¼–è¾‘å•†æˆ·æ¨¡æ€æ¡† -->
<div id="merchantModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff; padding: 30px; border-radius: 8px; width: 500px; max-height: 80vh; overflow-y: auto;">
        <h3 id="modalTitle" style="margin-bottom: 20px;">æ–°å¢å•†æˆ·</h3>
        <form id="merchantForm">
            <input type="hidden" id="merchantId" name="merchant_id">
            
            <div class="form-group">
                <label>å•†æˆ·åç§° *</label>
                <input type="text" name="name" id="name" required>
            </div>
            
            <div class="form-group">
                <label>å•†æˆ·ä»£ç </label>
                <input type="text" name="code" id="code">
            </div>
            
            <div class="form-group">
                <label>è”ç³»äººå§“å</label>
                <input type="text" name="contact_name" id="contact_name">
            </div>
            
            <div class="form-group">
                <label>è”ç³»äººæ‰‹æœº</label>
                <input type="text" name="contact_mobile" id="contact_mobile">
            </div>
            
            <div class="form-group">
                <label>è”ç³»äººé‚®ç®±</label>
                <input type="email" name="contact_email" id="contact_email">
            </div>
            
            <div class="form-group">
                <label>å¤‡æ³¨</label>
                <textarea name="remark" id="remark" rows="3"></textarea>
            </div>
            
            <div class="form-group" id="statusGroup" style="display: none;">
                <label>çŠ¶æ€</label>
                <select name="status" id="status">
                    <option value="1">æ­£å¸¸</option>
                    <option value="0">ç¦ç”¨</option>
                </select>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="submit" class="btn btn-primary" style="flex: 1;">ä¿å­˜</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal()" style="flex: 1;">å–æ¶ˆ</button>
            </div>
        </form>
    </div>
</div>

<script>
    function searchMerchants() {
        const search = document.getElementById('searchInput').value;
        window.location.href = '?search=' + encodeURIComponent(search);
    }
    
    function showCreateModal() {
        document.getElementById('modalTitle').textContent = 'æ–°å¢å•†æˆ·';
        document.getElementById('merchantForm').reset();
        document.getElementById('merchantId').value = '';
        document.getElementById('statusGroup').style.display = 'none';
        document.getElementById('merchantModal').style.display = 'block';
    }
    
    function editMerchant(merchantId) {
        // è·å–å½“å‰è¡Œçš„æ•°æ®
        const row = event.target.closest('tr');
        const cells = row.cells;
        
        document.getElementById('modalTitle').textContent = 'ç¼–è¾‘å•†æˆ·';
        document.getElementById('merchantId').value = merchantId;
        document.getElementById('name').value = cells[1].textContent;
        document.getElementById('code').value = cells[2].textContent !== '-' ? cells[2].textContent : '';
        document.getElementById('contact_name').value = cells[4].textContent !== '-' ? cells[4].textContent : '';
        document.getElementById('contact_mobile').value = cells[5].textContent !== '-' ? cells[5].textContent : '';
        document.getElementById('statusGroup').style.display = 'block';
        document.getElementById('status').value = cells[6].textContent.includes('æ­£å¸¸') ? '1' : '0';
        document.getElementById('merchantModal').style.display = 'block';
    }
    
    function closeModal() {
        document.getElementById('merchantModal').style.display = 'none';
    }
    
    function deleteMerchant(merchantId) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¯¥å•†æˆ·å—ï¼Ÿ')) return;
        
        const formData = new FormData();
        formData.append('merchant_id', merchantId);
        
        fetch('/merchant/delete', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            showToast(data.message, data.success ? 'success' : 'error');
            if (data.success) {
                setTimeout(() => location.reload(), 1000);
            }
        })
        .catch(error => {
            showToast('æ“ä½œå¤±è´¥', 'error');
        });
    }
    
    document.getElementById('merchantForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const merchantId = document.getElementById('merchantId').value;
        const url = merchantId ? '/merchant/update' : '/merchant/create';
        
        fetch(url, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            showToast(data.message, data.success ? 'success' : 'error');
            if (data.success) {
                setTimeout(() => location.reload(), 1000);
            }
        })
        .catch(error => {
            showToast('æ“ä½œå¤±è´¥', 'error');
        });
    });
    
    // æŒ‰Enteré”®æœç´¢
    document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') searchMerchants();
    });
</script>
{% endblock %}
