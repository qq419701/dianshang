{% extends "base.html" %}

{% block title %}ç”¨æˆ·ç®¡ç† - ç”µå•†å¹³å°ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="card">
    <h2>ğŸ‘¥ ç”¨æˆ·ç®¡ç†</h2>
    
    <div class="search-bar">
        <input type="text" id="searchInput" placeholder="æœç´¢ç”¨æˆ·å/å§“å/é‚®ç®±" value="{{ search }}">
        <button class="btn btn-primary" onclick="searchUsers()">æœç´¢</button>
        <button class="btn btn-success" onclick="showCreateModal()">æ–°å¢ç”¨æˆ·</button>
    </div>
    
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>ç”¨æˆ·å</th>
                <th>çœŸå®å§“å</th>
                <th>é‚®ç®±</th>
                <th>æ‰‹æœºå·</th>
                <th>è§’è‰²</th>
                <th>çŠ¶æ€</th>
                <th>æœ€åç™»å½•</th>
                <th>æ“ä½œ</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
            <tr>
                <td>{{ user.id }}</td>
                <td>{{ user.username }}</td>
                <td>{{ user.real_name or '-' }}</td>
                <td>{{ user.email or '-' }}</td>
                <td>{{ user.mobile or '-' }}</td>
                <td>{{ user.role.name if user.role else '-' }}</td>
                <td>
                    {% if user.status == 1 %}
                    <span class="badge badge-success">æ­£å¸¸</span>
                    {% else %}
                    <span class="badge badge-danger">ç¦ç”¨</span>
                    {% endif %}
                </td>
                <td>{{ user.last_login_time.strftime('%Y-%m-%d %H:%M') if user.last_login_time else '-' }}</td>
                <td>
                    <button class="btn btn-primary" onclick="editUser({{ user.id }})">ç¼–è¾‘</button>
                    <button class="btn btn-danger" onclick="deleteUser({{ user.id }})">åˆ é™¤</button>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="9" style="text-align: center; color: #999;">æš‚æ— æ•°æ®</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    {% if pagination.pages > 1 %}
    <div class="pagination">
        {% if pagination.has_prev %}
        <a href="?page={{ pagination.prev_num }}&search={{ search }}">ä¸Šä¸€é¡µ</a>
        {% endif %}
        
        {% for page_num in pagination.iter_pages(left_edge=2, right_edge=2, left_current=2, right_current=2) %}
            {% if page_num %}
                <a href="?page={{ page_num }}&search={{ search }}" 
                   class="{% if page_num == pagination.page %}active{% endif %}">
                    {{ page_num }}
                </a>
            {% else %}
                <span>...</span>
            {% endif %}
        {% endfor %}
        
        {% if pagination.has_next %}
        <a href="?page={{ pagination.next_num }}&search={{ search }}">ä¸‹ä¸€é¡µ</a>
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- æ–°å¢/ç¼–è¾‘ç”¨æˆ·æ¨¡æ€æ¡† -->
<div id="userModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff; padding: 30px; border-radius: 8px; width: 500px; max-height: 80vh; overflow-y: auto;">
        <h3 id="modalTitle" style="margin-bottom: 20px;">æ–°å¢ç”¨æˆ·</h3>
        <form id="userForm">
            <input type="hidden" id="userId" name="user_id">
            
            <div class="form-group">
                <label>ç”¨æˆ·å *</label>
                <input type="text" name="username" id="username" required>
            </div>
            
            <div class="form-group">
                <label>å¯†ç  <span id="passwordHint">(ç•™ç©ºä¸ä¿®æ”¹)</span></label>
                <input type="password" name="password" id="password">
            </div>
            
            <div class="form-group">
                <label>çœŸå®å§“å</label>
                <input type="text" name="real_name" id="real_name">
            </div>
            
            <div class="form-group">
                <label>é‚®ç®±</label>
                <input type="email" name="email" id="email">
            </div>
            
            <div class="form-group">
                <label>æ‰‹æœºå·</label>
                <input type="text" name="mobile" id="mobile">
            </div>
            
            <div class="form-group">
                <label>è§’è‰²</label>
                <select name="role_id" id="role_id">
                    <option value="">è¯·é€‰æ‹©è§’è‰²</option>
                    {% for role in roles %}
                    <option value="{{ role.id }}">{{ role.name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <label>å•†æˆ·ID</label>
                <input type="number" name="merchant_id" id="merchant_id" value="1">
            </div>
            
            <div class="form-group" id="statusGroup" style="display: none;">
                <label>çŠ¶æ€</label>
                <select name="status" id="status">
                    <option value="1">æ­£å¸¸</option>
                    <option value="0">ç¦ç”¨</option>
                </select>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="submit" class="btn btn-primary" style="flex: 1;">ä¿å­˜</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal()" style="flex: 1;">å–æ¶ˆ</button>
            </div>
        </form>
    </div>
</div>

<script>
    function searchUsers() {
        const search = document.getElementById('searchInput').value;
        window.location.href = '?search=' + encodeURIComponent(search);
    }
    
    function showCreateModal() {
        document.getElementById('modalTitle').textContent = 'æ–°å¢ç”¨æˆ·';
        document.getElementById('userForm').reset();
        document.getElementById('userId').value = '';
        document.getElementById('username').readOnly = false;
        document.getElementById('password').required = true;
        document.getElementById('passwordHint').textContent = '*';
        document.getElementById('statusGroup').style.display = 'none';
        document.getElementById('userModal').style.display = 'block';
    }
    
    function editUser(userId) {
        // è·å–å½“å‰è¡Œçš„æ•°æ®
        const row = event.target.closest('tr');
        const cells = row.cells;
        
        document.getElementById('modalTitle').textContent = 'ç¼–è¾‘ç”¨æˆ·';
        document.getElementById('userId').value = userId;
        document.getElementById('username').value = cells[1].textContent;
        document.getElementById('username').readOnly = true;
        document.getElementById('real_name').value = cells[2].textContent !== '-' ? cells[2].textContent : '';
        document.getElementById('email').value = cells[3].textContent !== '-' ? cells[3].textContent : '';
        document.getElementById('mobile').value = cells[4].textContent !== '-' ? cells[4].textContent : '';
        document.getElementById('password').required = false;
        document.getElementById('password').value = '';
        document.getElementById('passwordHint').textContent = '(ç•™ç©ºä¸ä¿®æ”¹)';
        document.getElementById('statusGroup').style.display = 'block';
        document.getElementById('status').value = cells[6].textContent.includes('æ­£å¸¸') ? '1' : '0';
        document.getElementById('userModal').style.display = 'block';
    }
    
    function closeModal() {
        document.getElementById('userModal').style.display = 'none';
    }
    
    function deleteUser(userId) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¯¥ç”¨æˆ·å—ï¼Ÿ')) return;
        
        const formData = new FormData();
        formData.append('user_id', userId);
        
        fetch('/user/delete', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            showToast(data.message, data.success ? 'success' : 'error');
            if (data.success) {
                setTimeout(() => location.reload(), 1000);
            }
        })
        .catch(error => {
            showToast('æ“ä½œå¤±è´¥', 'error');
        });
    }
    
    document.getElementById('userForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const userId = document.getElementById('userId').value;
        const url = userId ? '/user/update' : '/user/create';
        
        fetch(url, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            showToast(data.message, data.success ? 'success' : 'error');
            if (data.success) {
                setTimeout(() => location.reload(), 1000);
            }
        })
        .catch(error => {
            showToast('æ“ä½œå¤±è´¥', 'error');
        });
    });
    
    // æŒ‰Enteré”®æœç´¢
    document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') searchUsers();
    });
</script>
{% endblock %}
