{% extends "base.html" %}

{% block title %}ç»Ÿè®¡æŠ¥è¡¨ - ç”µå•†å¹³å°ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="card">
    <h2>ğŸ“Š ç»Ÿè®¡æŠ¥è¡¨</h2>
    
    <div class="search-bar">
        <select id="merchantSelect" onchange="loadStatistics()">
            <option value="">è¯·é€‰æ‹©å•†æˆ·</option>
            {% for merchant in merchants %}
            <option value="{{ merchant.id }}">{{ merchant.name }}</option>
            {% endfor %}
        </select>
        
        <input type="date" id="startDate">
        <input type="date" id="endDate">
        <button class="btn btn-primary" onclick="loadStatistics()">æŸ¥è¯¢</button>
    </div>
    
    <div id="statsContent" style="display: none;">
        <!-- å•†æˆ·ç»Ÿè®¡å¡ç‰‡ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="label">æ€»è®¢å•æ•°</div>
                <div class="value" id="totalOrders">0</div>
            </div>
            <div class="stat-card">
                <div class="label">æˆåŠŸè®¢å•</div>
                <div class="value" style="color: #34a853;" id="successOrders">0</div>
            </div>
            <div class="stat-card">
                <div class="label">å¤±è´¥è®¢å•</div>
                <div class="value" style="color: #ea4335;" id="failedOrders">0</div>
            </div>
            <div class="stat-card">
                <div class="label">æˆåŠŸç‡</div>
                <div class="value" style="color: #1a73e8;" id="successRate">0%</div>
            </div>
            <div class="stat-card">
                <div class="label">æ€»é‡‘é¢ï¼ˆå…ƒï¼‰</div>
                <div class="value" id="totalAmount">0</div>
            </div>
            <div class="stat-card">
                <div class="label">æˆåŠŸé‡‘é¢ï¼ˆå…ƒï¼‰</div>
                <div class="value" style="color: #34a853;" id="successAmount">0</div>
            </div>
        </div>
        
        <!-- åº—é“ºæµæ°´è¡¨æ ¼ -->
        <div style="margin-top: 30px;">
            <h3 style="font-size: 16px; margin-bottom: 16px;">åº—é“ºæµæ°´æ˜ç»†</h3>
            <table>
                <thead>
                    <tr>
                        <th>åº—é“ºåç§°</th>
                        <th>åº—é“ºç¼–ç </th>
                        <th>ä¸šåŠ¡ç±»å‹</th>
                        <th>æ€»è®¢å•</th>
                        <th>æˆåŠŸè®¢å•</th>
                        <th>å¤±è´¥è®¢å•</th>
                        <th>æˆåŠŸç‡</th>
                        <th>æ€»é‡‘é¢ï¼ˆå…ƒï¼‰</th>
                        <th>æˆåŠŸé‡‘é¢ï¼ˆå…ƒï¼‰</th>
                    </tr>
                </thead>
                <tbody id="shopStatsTable">
                    <tr>
                        <td colspan="9" style="text-align: center; color: #999;">æš‚æ— æ•°æ®</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- å›¾è¡¨å±•ç¤º -->
        <div style="margin-top: 30px;">
            <h3 style="font-size: 16px; margin-bottom: 16px;">åº—é“ºè®¢å•å¯¹æ¯”</h3>
            <div id="chartContainer" style="width: 100%; height: 400px;"></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<script>
let currentMerchantId = null;

function loadStatistics() {
    const merchantId = document.getElementById('merchantSelect').value;
    if (!merchantId) {
        alert('è¯·é€‰æ‹©å•†æˆ·');
        return;
    }
    
    currentMerchantId = merchantId;
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    let params = new URLSearchParams();
    if (startDate) params.append('start_date', startDate);
    if (endDate) params.append('end_date', endDate);
    
    // åŠ è½½å•†æˆ·ç»Ÿè®¡
    fetch(`/statistics/merchant/${merchantId}?${params}`)
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                displayMerchantStats(data.data);
            }
        });
    
    // åŠ è½½åº—é“ºç»Ÿè®¡
    fetch(`/statistics/shops/${merchantId}?${params}`)
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                displayShopStats(data.data);
            }
        });
    
    // åŠ è½½å›¾è¡¨æ•°æ®
    fetch(`/statistics/chart/${merchantId}?${params}`)
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                renderChart(data.data);
            }
        });
    
    document.getElementById('statsContent').style.display = 'block';
}

function displayMerchantStats(stats) {
    document.getElementById('totalOrders').textContent = stats.total_orders;
    document.getElementById('successOrders').textContent = stats.success_orders;
    document.getElementById('failedOrders').textContent = stats.failed_orders;
    document.getElementById('successRate').textContent = stats.success_rate + '%';
    document.getElementById('totalAmount').textContent = stats.total_amount.toFixed(2);
    document.getElementById('successAmount').textContent = stats.success_amount.toFixed(2);
}

function displayShopStats(shops) {
    const tbody = document.getElementById('shopStatsTable');
    
    if (shops.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #999;">æš‚æ— æ•°æ®</td></tr>';
        return;
    }
    
    tbody.innerHTML = shops.map(shop => `
        <tr>
            <td>${shop.shop_name}</td>
            <td>${shop.shop_code || '-'}</td>
            <td>${shop.biz_type_name}</td>
            <td>${shop.total_orders}</td>
            <td>${shop.success_orders}</td>
            <td>${shop.failed_orders}</td>
            <td>${shop.success_rate}%</td>
            <td>${shop.total_amount.toFixed(2)}</td>
            <td>${shop.success_amount.toFixed(2)}</td>
        </tr>
    `).join('');
}

function renderChart(chartData) {
    const chartDom = document.getElementById('chartContainer');
    const myChart = echarts.init(chartDom);
    
    const option = {
        tooltip: {
            trigger: 'axis',
            axisPointer: { type: 'shadow' }
        },
        legend: {
            data: ['è®¢å•æ•°', 'é‡‘é¢ï¼ˆå…ƒï¼‰']
        },
        xAxis: {
            type: 'category',
            data: chartData.shop_names,
            axisLabel: {
                interval: 0,
                rotate: 30
            }
        },
        yAxis: [
            {
                type: 'value',
                name: 'è®¢å•æ•°',
                position: 'left'
            },
            {
                type: 'value',
                name: 'é‡‘é¢ï¼ˆå…ƒï¼‰',
                position: 'right'
            }
        ],
        series: [
            {
                name: 'è®¢å•æ•°',
                type: 'bar',
                data: chartData.shop_orders,
                itemStyle: { color: '#1a73e8' }
            },
            {
                name: 'é‡‘é¢ï¼ˆå…ƒï¼‰',
                type: 'line',
                yAxisIndex: 1,
                data: chartData.shop_amounts,
                itemStyle: { color: '#34a853' }
            }
        ]
    };
    
    myChart.setOption(option);
}

// è®¾ç½®é»˜è®¤æ—¥æœŸèŒƒå›´ä¸ºæœ€è¿‘7å¤©
(function() {
    const today = new Date();
    const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
    
    document.getElementById('endDate').valueAsDate = today;
    document.getElementById('startDate').valueAsDate = weekAgo;
    
    // å¦‚æœåªæœ‰ä¸€ä¸ªå•†æˆ·ï¼Œè‡ªåŠ¨é€‰ä¸­
    const select = document.getElementById('merchantSelect');
    if (select.options.length === 2) {
        select.selectedIndex = 1;
        loadStatistics();
    }
})();
</script>
{% endblock %}
