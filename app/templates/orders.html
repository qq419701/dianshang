{% extends "base.html" %}
{% block title %}è®¢å•ç®¡ç† â€” ç”µå•†å¹³å°ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block content %}
<h2 style="margin-bottom: 20px; font-size: 20px;">ğŸ“‹ è®¢å•ç®¡ç†</h2>

<!-- æœç´¢æ  -->
<div class="card">
    <form method="GET" action="/admin/orders" class="search-bar">
        <input type="text" name="search" value="{{ search }}" placeholder="è¾“å…¥äº¬ä¸œè®¢å•å·æˆ–æˆ‘æ–¹è®¢å•å·æœç´¢...">
        
        <select name="merchant_id" id="merchantSelect" onchange="loadShops(this.value)">
            <option value="0" {% if merchant_id == 0 %}selected{% endif %}>å…¨éƒ¨å•†æˆ·</option>
            {% for merchant in merchants %}
            <option value="{{ merchant.id }}" {% if merchant_id == merchant.id %}selected{% endif %}>{{ merchant.name }}</option>
            {% endfor %}
        </select>
        
        <select name="shop_id" id="shopSelect">
            <option value="0" {% if shop_id == 0 %}selected{% endif %}>å…¨éƒ¨åº—é“º</option>
            {% for shop in shops %}
            <option value="{{ shop.id }}" {% if shop_id == shop.id %}selected{% endif %}>{{ shop.shop_name }}</option>
            {% endfor %}
        </select>
        
        <select name="biz_type">
            <option value="0" {% if biz_type == 0 %}selected{% endif %}>å…¨éƒ¨ä¸šåŠ¡ç±»å‹</option>
            <option value="1" {% if biz_type == 1 %}selected{% endif %}>é€šç”¨äº¤æ˜“</option>
            <option value="2" {% if biz_type == 2 %}selected{% endif %}>æ¸¸æˆç‚¹å¡</option>
        </select>
        <select name="status">
            <option value="-1" {% if status == -1 %}selected{% endif %}>å…¨éƒ¨çŠ¶æ€</option>
            <option value="0" {% if status == 0 %}selected{% endif %}>æˆåŠŸ</option>
            <option value="1" {% if status == 1 %}selected{% endif %}>å……å€¼ä¸­</option>
            <option value="2" {% if status == 2 %}selected{% endif %}>å¤±è´¥</option>
            <option value="3" {% if status == 3 %}selected{% endif %}>ç”Ÿäº§ä¸­</option>
            <option value="4" {% if status == 4 %}selected{% endif %}>å¼‚å¸¸</option>
        </select>
        <button type="submit" class="btn btn-primary">ğŸ” æœç´¢</button>
    </form>
</div>

<!-- è®¢å•åˆ—è¡¨ -->
<div class="card">
    <h2>è®¢å•åˆ—è¡¨</h2>
    <table>
        <thead>
            <tr>
                <th>æˆ‘æ–¹è®¢å•å·</th>
                <th>äº¬ä¸œè®¢å•å·</th>
                <th>å•†æˆ·</th>
                <th>åº—é“º</th>
                <th>ä¸šåŠ¡ç±»å‹</th>
                <th>è®¢å•çŠ¶æ€</th>
                <th>é‡‘é¢ï¼ˆå…ƒï¼‰</th>
                <th>æ•°é‡</th>
                <th>å……å€¼è´¦å·</th>
                <th>æ”¯ä»˜æ—¶é—´</th>
                <th>åˆ›å»ºæ—¶é—´</th>
            </tr>
        </thead>
        <tbody>
            {% for order in orders %}
            <tr>
                <td>{{ order.order_no }}</td>
                <td>{{ order.jd_order_no }}</td>
                <td>{{ order.merchant_id }}</td>
                <td>{{ order.shop_id or '-' }}</td>
                <td>
                    {% if order.biz_type == 1 %}
                        <span class="badge badge-info">é€šç”¨äº¤æ˜“</span>
                    {% else %}
                        <span class="badge badge-info">æ¸¸æˆç‚¹å¡</span>
                    {% endif %}
                </td>
                <td>
                    {% if order.order_status == 0 %}
                        <span class="badge badge-success">æˆåŠŸ</span>
                    {% elif order.order_status == 1 %}
                        <span class="badge badge-warning">å……å€¼ä¸­</span>
                    {% elif order.order_status == 2 %}
                        <span class="badge badge-danger">å¤±è´¥</span>
                    {% elif order.order_status == 3 %}
                        <span class="badge badge-warning">ç”Ÿäº§ä¸­</span>
                    {% elif order.order_status == 4 %}
                        <span class="badge badge-danger">å¼‚å¸¸</span>
                    {% else %}
                        <span class="badge">æœªçŸ¥</span>
                    {% endif %}
                </td>
                <td>{{ "%.2f"|format((order.amount or 0) / 100) }}</td>
                <td>{{ order.quantity or '-' }}</td>
                <td>{{ order.produce_account or '-' }}</td>
                <td>{{ order.pay_time.strftime('%Y-%m-%d %H:%M') if order.pay_time else '-' }}</td>
                <td>{{ order.create_time.strftime('%Y-%m-%d %H:%M') if order.create_time else '-' }}</td>
            </tr>
            {% endfor %}
            {% if not orders %}
            <tr>
                <td colspan="11" style="text-align: center; color: #999; padding: 40px;">æš‚æ— è®¢å•æ•°æ®</td>
            </tr>
            {% endif %}
        </tbody>
    </table>

    <!-- åˆ†é¡µ -->
    {% if pagination.pages > 1 %}
    <div class="pagination">
        {% if pagination.has_prev %}
        <a href="?page={{ pagination.prev_num }}&search={{ search }}&merchant_id={{ merchant_id }}&shop_id={{ shop_id }}&biz_type={{ biz_type }}&status={{ status }}">ä¸Šä¸€é¡µ</a>
        {% endif %}

        {% for p in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
            {% if p %}
                <a href="?page={{ p }}&search={{ search }}&merchant_id={{ merchant_id }}&shop_id={{ shop_id }}&biz_type={{ biz_type }}&status={{ status }}" class="{% if p == pagination.page %}active{% endif %}">{{ p }}</a>
            {% else %}
                <span style="padding: 6px;">...</span>
            {% endif %}
        {% endfor %}

        {% if pagination.has_next %}
        <a href="?page={{ pagination.next_num }}&search={{ search }}&merchant_id={{ merchant_id }}&shop_id={{ shop_id }}&biz_type={{ biz_type }}&status={{ status }}">ä¸‹ä¸€é¡µ</a>
        {% endif %}
    </div>
    {% endif %}
</div>

<script>
function loadShops(merchantId) {
    const shopSelect = document.getElementById('shopSelect');
    shopSelect.innerHTML = '<option value="0">å…¨éƒ¨åº—é“º</option>';
    
    if (!merchantId || merchantId == '0') return;
    
    fetch('/shop/list/' + merchantId)
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                data.data.forEach(shop => {
                    const option = document.createElement('option');
                    option.value = shop.id;
                    option.textContent = shop.shop_name;
                    shopSelect.appendChild(option);
                });
            }
        })
        .catch(err => console.error('åŠ è½½åº—é“ºå¤±è´¥', err));
}

// é¡µé¢åŠ è½½æ—¶å¦‚æœå·²é€‰æ‹©å•†æˆ·ï¼Œåˆ™åŠ è½½åº—é“ºåˆ—è¡¨
window.addEventListener('DOMContentLoaded', function() {
    const merchantId = document.getElementById('merchantSelect').value;
    if (merchantId && merchantId != '0') {
        loadShops(merchantId);
        // æ¢å¤ä¹‹å‰é€‰æ‹©çš„åº—é“º
        setTimeout(() => {
            const shopId = {{ shop_id }};
            if (shopId) {
                document.getElementById('shopSelect').value = shopId;
            }
        }, 500);
    }
});
</script>
{% endblock %}
