# ç”¨æˆ·è®¤è¯ç³»ç»Ÿéƒ¨ç½²æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜å¦‚ä½•éƒ¨ç½²æ–°å¢çš„ç”¨æˆ·è®¤è¯å’Œæƒé™ç®¡ç†ç³»ç»Ÿã€‚

## ğŸ¯ æ–°å¢åŠŸèƒ½

### 1. ç”¨æˆ·è®¤è¯ç³»ç»Ÿ
- âœ… ç™»å½•/ç™»å‡ºåŠŸèƒ½
- âœ… Session ç®¡ç†ï¼ˆ7å¤©æœ‰æ•ˆæœŸï¼‰
- âœ… å¯†ç åŠ å¯†å­˜å‚¨ï¼ˆpbkdf2:sha256ï¼‰
- âœ… ç™»å½•æ—¥å¿—è®°å½•ï¼ˆIPåœ°å€ã€æ—¶é—´ï¼‰

### 2. ç”¨æˆ·ä¸è§’è‰²ç®¡ç†
- âœ… ç”¨æˆ· CRUDï¼ˆå¢åˆ æ”¹æŸ¥ï¼‰
- âœ… è§’è‰²æƒé™ç³»ç»Ÿï¼ˆ4ç§é¢„è®¾è§’è‰²ï¼‰
- âœ… æƒé™éªŒè¯è£…é¥°å™¨
- âœ… å•†æˆ·å…³è”ç®¡ç†

### 3. å•†æˆ·ç®¡ç†ç³»ç»Ÿ
- âœ… å•†æˆ· CRUD
- âœ… å•†æˆ·ä¸ç”¨æˆ·å…³è”
- âœ… å•†æˆ·ä¸é…ç½®å…³è”

### 4. é€šçŸ¥ç³»ç»Ÿ
- âœ… é‚®ä»¶é€šçŸ¥ï¼ˆSMTPï¼‰
- âœ… Webhook é€šçŸ¥ï¼ˆHTTP POSTï¼‰
- âœ… ç«™å†…æ¶ˆæ¯
- âœ… é€šçŸ¥é…ç½®ç®¡ç†
- âœ… é€šçŸ¥æ—¥å¿—è®°å½•

### 5. æ“ä½œæ—¥å¿—å®¡è®¡
- âœ… ç™»å½•/ç™»å‡ºæ—¥å¿—
- âœ… ç”¨æˆ·ç®¡ç†æ“ä½œæ—¥å¿—
- âœ… å•†æˆ·ç®¡ç†æ“ä½œæ—¥å¿—
- âœ… é…ç½®ä¿®æ”¹æ“ä½œæ—¥å¿—

## ğŸ“¦ éƒ¨ç½²æ­¥éª¤

### æ­¥éª¤1ï¼šå¤‡ä»½ç°æœ‰ç³»ç»Ÿ

```bash
# å¤‡ä»½æ•°æ®åº“
mysqldump -u root -p dianshang > backup_$(date +%Y%m%d_%H%M%S).sql

# å¤‡ä»½ä»£ç 
tar -czf code_backup_$(date +%Y%m%d_%H%M%S).tar.gz /path/to/dianshang
```

### æ­¥éª¤2ï¼šæ›´æ–°ä»£ç 

```bash
# æ‹‰å–æœ€æ–°ä»£ç 
cd /path/to/dianshang
git pull origin main  # æˆ–æ‚¨çš„åˆ†æ”¯åç§°
```

### æ­¥éª¤3ï¼šæ‰§è¡Œæ•°æ®åº“è¿ç§»

```bash
# æ‰§è¡Œæ•°æ®åº“å‡çº§è„šæœ¬
mysql -u root -p dianshang < migrations/upgrade_user_system.sql
```

æ•°æ®åº“å‡çº§åä¼šè‡ªåŠ¨åˆ›å»ºä»¥ä¸‹è¡¨ï¼š
- `merchants` - å•†æˆ·è¡¨
- `roles` - è§’è‰²è¡¨
- `users` - ç”¨æˆ·è¡¨
- `notifications` - ç«™å†…æ¶ˆæ¯è¡¨
- `notification_configs` - é€šçŸ¥é…ç½®è¡¨
- `notification_logs` - é€šçŸ¥æ—¥å¿—è¡¨
- `operation_logs` - æ“ä½œæ—¥å¿—è¡¨

### æ­¥éª¤4ï¼šé…ç½®ç¯å¢ƒå˜é‡

ç¼–è¾‘ `.env` æ–‡ä»¶ï¼Œæ·»åŠ é‚®ä»¶é…ç½®ï¼ˆå¯é€‰ï¼‰ï¼š

```bash
# é‚®ä»¶é€šçŸ¥é…ç½®ï¼ˆå¯é€‰ï¼‰
SMTP_SERVER=smtp.example.com
SMTP_PORT=465
SMTP_USER=your_email@example.com
SMTP_PASSWORD=your_email_password
SMTP_FROM=noreply@example.com
```

å¦‚æœä¸ä½¿ç”¨é‚®ä»¶é€šçŸ¥ï¼Œå¯ä»¥ç•™ç©ºæˆ–ä¸é…ç½®ã€‚

### æ­¥éª¤5ï¼šåˆ›å»ºç®¡ç†å‘˜è´¦å·

```bash
# æ‰§è¡Œç®¡ç†å‘˜è´¦å·åˆ›å»ºè„šæœ¬
python3 scripts/create_admin.py
```

æ‰§è¡ŒæˆåŠŸåä¼šæ˜¾ç¤ºï¼š

```
âœ… ç®¡ç†å‘˜è´¦å·åˆ›å»ºæˆåŠŸï¼
==================================================
ç”¨æˆ·åï¼šadmin
å¯†ç ï¼šadmin123
è§’è‰²ï¼šè¶…çº§ç®¡ç†å‘˜
==================================================
âš ï¸  é‡è¦æç¤ºï¼šé¦–æ¬¡ç™»å½•åè¯·ç«‹å³ä¿®æ”¹å¯†ç ï¼
```

### æ­¥éª¤6ï¼šé‡å¯æœåŠ¡

```bash
# å¦‚æœä½¿ç”¨systemd
sudo systemctl restart dianshang

# å¦‚æœä½¿ç”¨Gunicorn
pkill -f gunicorn
gunicorn -c gunicorn.conf.py run:app

# å¦‚æœä½¿ç”¨Flaskå¼€å‘æœåŠ¡å™¨
python3 run.py
```

### æ­¥éª¤7ï¼šéªŒè¯éƒ¨ç½²

1. **è®¿é—®ç™»å½•é¡µé¢**
   ```
   http://your-domain.com/auth/login
   ```

2. **ä½¿ç”¨ç®¡ç†å‘˜è´¦å·ç™»å½•**
   - ç”¨æˆ·åï¼š`admin`
   - å¯†ç ï¼š`admin123`

3. **éªŒè¯åŠŸèƒ½**
   - [ ] ç™»å½•æˆåŠŸåè·³è½¬åˆ°ç®¡ç†é¦–é¡µ
   - [ ] é¡¶éƒ¨å¯¼èˆªæ æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
   - [ ] å¯ä»¥è®¿é—®ç”¨æˆ·ç®¡ç†é¡µé¢
   - [ ] å¯ä»¥è®¿é—®å•†æˆ·ç®¡ç†é¡µé¢
   - [ ] å¯ä»¥è®¿é—®é€šçŸ¥æ¶ˆæ¯é¡µé¢
   - [ ] æœªç™»å½•è®¿é—®ç®¡ç†é¡µé¢ä¼šè·³è½¬åˆ°ç™»å½•é¡µ

## ğŸ” é»˜è®¤è§’è‰²è¯´æ˜

ç³»ç»Ÿé¢„è®¾äº†4ç§è§’è‰²ï¼š

### 1. è¶…çº§ç®¡ç†å‘˜ (super_admin)
- æƒé™ï¼š`["*:*"]`ï¼ˆæ‰€æœ‰æƒé™ï¼‰
- åŠŸèƒ½ï¼šå®Œå…¨æ§åˆ¶ç³»ç»Ÿ

### 2. ç®¡ç†å‘˜ (admin)
- æƒé™ï¼š`["merchant:*", "order:*", "config:*", "user:view"]`
- åŠŸèƒ½ï¼šå•†æˆ·ç®¡ç†ã€è®¢å•ç®¡ç†ã€é…ç½®ç®¡ç†ã€æŸ¥çœ‹ç”¨æˆ·

### 3. æ“ä½œå‘˜ (operator)
- æƒé™ï¼š`["order:view", "order:update"]`
- åŠŸèƒ½ï¼šæŸ¥çœ‹å’Œå¤„ç†è®¢å•

### 4. æŸ¥çœ‹è€… (viewer)
- æƒé™ï¼š`["order:view", "config:view"]`
- åŠŸèƒ½ï¼šåªè¯»æƒé™

## ğŸ”§ æƒé™ä»£ç è¯´æ˜

æƒé™æ ¼å¼ï¼š`æ¨¡å—:æ“ä½œ`

### æ”¯æŒçš„æ¨¡å—ï¼š
- `user` - ç”¨æˆ·ç®¡ç†
- `merchant` - å•†æˆ·ç®¡ç†
- `order` - è®¢å•ç®¡ç†
- `config` - é…ç½®ç®¡ç†

### æ”¯æŒçš„æ“ä½œï¼š
- `view` - æŸ¥çœ‹
- `create` - åˆ›å»º
- `update` - æ›´æ–°
- `delete` - åˆ é™¤
- `*` - æ‰€æœ‰æ“ä½œ

### é€šé…ç¬¦ï¼š
- `*:*` - æ‰€æœ‰æƒé™
- `user:*` - ç”¨æˆ·æ¨¡å—æ‰€æœ‰æƒé™

## ğŸ“§ é€šçŸ¥ç³»ç»Ÿé…ç½®

### é‚®ä»¶é€šçŸ¥

åœ¨ `.env` ä¸­é…ç½®SMTPä¿¡æ¯ï¼š

```bash
SMTP_SERVER=smtp.gmail.com
SMTP_PORT=465
SMTP_USER=your-email@gmail.com
SMTP_PASSWORD=your-app-password
SMTP_FROM=noreply@example.com
```

### Webhooké€šçŸ¥

åœ¨é€šçŸ¥é…ç½®é¡µé¢è®¾ç½®Webhook URLï¼Œç³»ç»Ÿä¼šå‘é€POSTè¯·æ±‚ï¼š

```json
{
  "merchant_id": 1,
  "scene": "order_create",
  "title": "æ–°è®¢å•åˆ›å»º",
  "content": "è®¢å•å·ï¼šxxx",
  "timestamp": "2024-01-01T00:00:00"
}
```

### ç«™å†…æ¶ˆæ¯

è‡ªåŠ¨å‘é€ç»™ç›¸å…³ç”¨æˆ·ï¼Œå¯åœ¨é€šçŸ¥æ¶ˆæ¯é¡µé¢æŸ¥çœ‹ã€‚

## ğŸ”’ å®‰å…¨ç‰¹æ€§

1. **å¯†ç å®‰å…¨**
   - ä½¿ç”¨ Werkzeug çš„ pbkdf2:sha256 åŠ å¯†
   - ä¸å­˜å‚¨æ˜æ–‡å¯†ç 

2. **Sessionå®‰å…¨**
   - HttpOnly Cookieï¼ˆé˜²æ­¢XSSï¼‰
   - SameSite=Laxï¼ˆé˜²æ­¢CSRFï¼‰
   - 7å¤©æœ‰æ•ˆæœŸ

3. **æƒé™æ§åˆ¶**
   - è£…é¥°å™¨å¼ºåˆ¶æ£€æŸ¥æƒé™
   - æœªç™»å½•è‡ªåŠ¨è·³è½¬ç™»å½•é¡µ

4. **æ“ä½œå®¡è®¡**
   - è®°å½•æ‰€æœ‰æ•æ„Ÿæ“ä½œ
   - è®°å½•IPåœ°å€å’ŒUser-Agent

## ğŸ“ å¸¸è§é—®é¢˜

### Q1ï¼šå¿˜è®°ç®¡ç†å‘˜å¯†ç æ€ä¹ˆåŠï¼Ÿ

å¯ä»¥é‡æ–°è¿è¡Œåˆ›å»ºç®¡ç†å‘˜è„šæœ¬ï¼Œæˆ–æ‰‹åŠ¨ä¿®æ”¹æ•°æ®åº“ï¼š

```python
from app import create_app, db
from app.models.user import User

app = create_app()
with app.app_context():
    user = User.query.filter_by(username='admin').first()
    user.set_password('new_password')
    db.session.commit()
```

### Q2ï¼šå¦‚ä½•æ·»åŠ æ–°è§’è‰²ï¼Ÿ

åœ¨æ•°æ®åº“ä¸­æ’å…¥æ–°è§’è‰²ï¼š

```sql
INSERT INTO roles (name, code, description, permissions, status) 
VALUES ('è‡ªå®šä¹‰è§’è‰²', 'custom_role', 'æè¿°', '["order:view"]', 1);
```

### Q3ï¼šå¦‚ä½•ä¿®æ”¹Sessionæœ‰æ•ˆæœŸï¼Ÿ

ä¿®æ”¹ `app/__init__.py` ä¸­çš„é…ç½®ï¼š

```python
app.config['PERMANENT_SESSION_LIFETIME'] = timedelta(days=30)  # æ”¹ä¸º30å¤©
```

### Q4ï¼šé‚®ä»¶å‘é€å¤±è´¥æ€ä¹ˆåŠï¼Ÿ

æ£€æŸ¥ï¼š
1. SMTPé…ç½®æ˜¯å¦æ­£ç¡®
2. é‚®ç®±æ˜¯å¦å¼€å¯SMTPæœåŠ¡
3. æ˜¯å¦éœ€è¦ä½¿ç”¨åº”ç”¨ä¸“ç”¨å¯†ç ï¼ˆå¦‚Gmailï¼‰
4. é˜²ç«å¢™æ˜¯å¦é˜»æ­¢SMTPç«¯å£

æŸ¥çœ‹æ—¥å¿—ï¼š
```sql
SELECT * FROM notification_logs WHERE status = 0 ORDER BY create_time DESC LIMIT 10;
```

### Q5ï¼šå¦‚ä½•ç¦ç”¨æŸä¸ªç”¨æˆ·ï¼Ÿ

åœ¨ç”¨æˆ·ç®¡ç†é¡µé¢ç¼–è¾‘ç”¨æˆ·ï¼Œå°†çŠ¶æ€è®¾ç½®ä¸º"ç¦ç”¨"ï¼Œæˆ–ç›´æ¥ä¿®æ”¹æ•°æ®åº“ï¼š

```sql
UPDATE users SET status = 0 WHERE username = 'username';
```

## ğŸš¨ å®‰å…¨å»ºè®®

1. **é¦–æ¬¡ç™»å½•åç«‹å³ä¿®æ”¹é»˜è®¤å¯†ç **
2. **å®šæœŸå®¡æŸ¥æ“ä½œæ—¥å¿—**
3. **ä¸è¦ä½¿ç”¨å¼±å¯†ç **
4. **å®šæœŸå¤‡ä»½æ•°æ®åº“**
5. **åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨HTTPS**
6. **é™åˆ¶ç®¡ç†åå°IPè®¿é—®ï¼ˆæ¨èï¼‰**

## ğŸ“Š æ•°æ®åº“è¡¨å…³ç³»

```
merchants (å•†æˆ·)
    â”œâ”€â”€ users (ç”¨æˆ·)
    â”‚   â”œâ”€â”€ notifications (ç«™å†…æ¶ˆæ¯)
    â”‚   â””â”€â”€ operation_logs (æ“ä½œæ—¥å¿—)
    â”œâ”€â”€ merchant_jd_config (äº¬ä¸œé…ç½®)
    â””â”€â”€ notification_configs (é€šçŸ¥é…ç½®)

roles (è§’è‰²)
    â””â”€â”€ users (ç”¨æˆ·)
```

## ğŸ“š ç›¸å…³æ–‡ä»¶

- `migrations/upgrade_user_system.sql` - æ•°æ®åº“è¿ç§»è„šæœ¬
- `scripts/create_admin.py` - ç®¡ç†å‘˜åˆ›å»ºè„šæœ¬
- `app/models/user.py` - ç”¨æˆ·å’Œè§’è‰²æ¨¡å‹
- `app/models/merchant.py` - å•†æˆ·æ¨¡å‹
- `app/services/auth_service.py` - è®¤è¯æœåŠ¡
- `app/utils/auth_decorator.py` - æƒé™è£…é¥°å™¨
- `app/templates/auth/login.html` - ç™»å½•é¡µé¢

## ğŸ”„ å›æ»šæ–¹æ¡ˆ

å¦‚æœéƒ¨ç½²å‡ºç°é—®é¢˜ï¼Œå¯ä»¥å›æ»šï¼š

```bash
# 1. æ¢å¤æ•°æ®åº“
mysql -u root -p dianshang < backup_YYYYMMDD_HHMMSS.sql

# 2. æ¢å¤ä»£ç 
git checkout previous_commit_hash

# 3. é‡å¯æœåŠ¡
sudo systemctl restart dianshang
```

## âœ… éƒ¨ç½²æ£€æŸ¥æ¸…å•

- [ ] æ•°æ®åº“å¤‡ä»½å®Œæˆ
- [ ] ä»£ç å¤‡ä»½å®Œæˆ
- [ ] æ•°æ®åº“è¿ç§»æ‰§è¡ŒæˆåŠŸ
- [ ] ç¯å¢ƒå˜é‡é…ç½®å®Œæˆ
- [ ] ç®¡ç†å‘˜è´¦å·åˆ›å»ºæˆåŠŸ
- [ ] æœåŠ¡é‡å¯æˆåŠŸ
- [ ] ç™»å½•åŠŸèƒ½æµ‹è¯•é€šè¿‡
- [ ] ç”¨æˆ·ç®¡ç†åŠŸèƒ½æµ‹è¯•é€šè¿‡
- [ ] å•†æˆ·ç®¡ç†åŠŸèƒ½æµ‹è¯•é€šè¿‡
- [ ] æƒé™æ§åˆ¶æµ‹è¯•é€šè¿‡
- [ ] åŸæœ‰åŠŸèƒ½æµ‹è¯•é€šè¿‡

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»æŠ€æœ¯æ”¯æŒæˆ–æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—ï¼š

```bash
# æŸ¥çœ‹åº”ç”¨æ—¥å¿—
tail -f logs/app.log

# æŸ¥çœ‹æ•°æ®åº“æ—¥å¿—
tail -f /var/log/mysql/error.log
```
