# 京东通用交易 & 游戏点卡 & 阿奇索开放平台 — 接口分析文档

> **版本**：V1.0  
> **编制日期**：2026-02-17  
> **文档定位**：基于仓库内《京东通用交易平台接口文档》、《京东游戏点卡平台接口文档》及阿奇索开放平台公开文档，进行全面的接口分析与开发指引。

---

## 目录

1. [总览与三方平台对比](#1-总览与三方平台对比)
2. [京东通用交易平台接口分析](#2-京东通用交易平台接口分析)
3. [京东游戏点卡平台接口分析](#3-京东游戏点卡平台接口分析)
4. [阿奇索开放平台接口分析](#4-阿奇索开放平台接口分析)
5. [三平台加密签名差异对比](#5-三平台加密签名差异对比)
6. [接口地址汇总与配置要求](#6-接口地址汇总与配置要求)
7. [错误码体系汇总](#7-错误码体系汇总)
8. [数据库表设计建议](#8-数据库表设计建议)
9. [开发核心注意事项](#9-开发核心注意事项)

---

## 1. 总览与三方平台对比

### 1.1 三平台角色定位

| 平台 | 调用方向 | 核心角色 | 协议 |
|------|---------|---------|------|
| **京东通用交易** | 京东 → 我方（提交充值/反查）；我方 → 京东（回调通知） | 我方作为代理商/供应商 | HTTP POST, UTF-8 |
| **京东游戏点卡** | 京东 → 我方（接单/查询/校验）；我方 → 京东（直充回调/卡密回调） | 我方作为合作商家 | HTTP POST/GET, UTF-8（回调data需GBK编码） |
| **阿奇索开放平台** | 我方 → 阿奇索（拉单/发货/查询） | 我方作为开发方调用阿奇索API | HTTP POST, UTF-8 |

### 1.2 业务流程概述

```
┌──────────┐       订单支付后        ┌──────────┐
│  京东平台  │ ───────────────────► │  我方系统  │
│          │  beginDistill/接单接口  │          │
│          │ ◄─────────────────── │          │
│          │    同步返回结果         │          │
│          │                       │          │
│          │  findDistill/查询接口   │          │
│          │ ───────────────────► │          │
│          │ ◄─────────────────── │          │
│          │    返回生产状态         │          │
│          │                       │          │
│          │  回调通知(异步)         │          │
│          │ ◄─────────────────── │          │
│          │  produce/result       │          │
│          │  gameApi/cardApi      │          │
└──────────┘                       └──────────┘
                                        │
                                        │ 可选：自动发货
                                        ▼
                                   ┌──────────┐
                                   │ 阿奇索平台 │
                                   └──────────┘
```

---

## 2. 京东通用交易平台接口分析

### 2.1 技术规范

| 项目 | 说明 |
|------|------|
| **请求格式** | HTTP POST |
| **编码** | UTF-8 |
| **数据格式** | 驼峰命名法（如 jdOrderNo） |
| **加密方式** | AES-256，ECB 模式，秘钥长度 32 bytes，默认 Java PKCS5Padding |
| **签名方式** | MD5：将所有业务参数（排除 sign、signType）按 key 字母升序排列拼接，格式 `key1=value1&key2=value2&...&PRIVATEKEY`，需加密的参数使用加密后的值参与签名，MD5 结果取 32 位小写 hex |

### 2.2 接口清单

| 编号 | 接口名称 | 接口提供方 | 接口调用方 | 触发条件 | Method |
|------|---------|-----------|-----------|---------|--------|
| 1 | 提交充值 & 提取卡密 | **我方** | **京东** | 订单支付完成后 | `beginDistill` |
| 2 | 生产反查 | **我方** | **京东** | 京东未收到生产结果时 | `findDistill` |
| 3 | 回调通知 | **京东** | **我方** | 生产完成后我方主动通知 | `/produce/result` |

### 2.3 接口详细参数

#### 2.3.1 提交充值 & 提取卡密（beginDistill）

**请求方向**：京东 → 我方  
**请求方式**：HTTP POST  
**Content-Type**：`application/x-www-form-urlencoded`  
**性能要求**：同步生产 tp999 ≤ 600ms

**请求输入参数：**

| 字段名称 | 变量名 | 类型 | 必填 | 说明 |
|---------|--------|------|------|------|
| 签名 | `sign` | String | Y | MD5签名 |
| 签名方式 | `signType` | String | Y | 固定 `MD5` |
| 访问时间戳 | `timestamp` | String | Y | 格式：`yyyyMMddHHmmss` |
| 京东订单号 | `jdOrderNo` | Long | Y | 唯一流水，**必须做防重处理** |
| 支付时间 | `payTime` | String | Y | 格式：`yyyyMMddHHmmss` |
| 回调通知地址 | `notifyUrl` | String | Y | 异步生产时我方回调此地址 |
| 充值号码 | `produceAccount` | String | N | 卡密类型不传；联调前需提供长度范围 |
| 数量 | `quantity` | Integer | Y | 直充类型只能为1 |
| 商品编码 | `wareNo` | String | Y | 京东SKUID或商家商品编码映射 |
| 订单总价格 | `totalPrice` | Long | Y | 单位：分 |
| 商家ID | `vendorId` | Long | Y | 京东分配的商家唯一编号 |
| 特殊属性 | `expand` | JSON | N | 包含货款等信息，需 AES 加密后 URLencode |

**请求输出参数（我方返回给京东）：**

| 字段名称 | 变量名 | 类型 | 必填 | 说明 |
|---------|--------|------|------|------|
| 签名 | `sign` | String | Y | MD5签名 |
| 签名方式 | `signType` | String | Y | 固定 `MD5` |
| 响应时间戳 | `timestamp` | String | Y | 格式：`yyyyMMddHHmmss` |
| 错误码 | `code` | String | Y | 见错误码表 |
| 京东订单号 | `jdOrderNo` | Long | Y | 原样返回 |
| 代理商订单号 | `agentOrderNo` | String | Y | 我方唯一流水号 |
| 生产状态 | `produceStatus` | Integer | Y | 1=成功, 2=失败, 3=生产中, 4=异常 |
| 卡密信息 | `product` | String | N | JSON数组 AES 加密后的字符串 |

**生产状态枚举：**

| 状态 | 值 | 说明 | 后续动作 |
|------|---|------|---------|
| 生产成功 | 1 | 直接完成，卡密同时返回 | 无需回调/反查 |
| 生产失败 | 2 | 直接失败，系统自动退款 | 无需回调/反查 |
| 生产中 | 3 | 异步处理中 | **必须回调+支持反查** |
| 生产异常 | 4 | 暂停订单，等待京东重试 | 京东发起重试 |

**卡密信息格式（AES加密前）：**
```json
[
  {
    "cardNumber": "123456",
    "password": "654321",
    "expiryDate": "2016-10-10",
    "limitNum": 1
  }
]
```

#### 2.3.2 生产反查（findDistill）

**请求方向**：京东 → 我方  
**请求方式**：HTTP POST  
**Content-Type**：`application/x-www-form-urlencoded`

**请求输入参数：**

| 字段名称 | 变量名 | 类型 | 必填 | 说明 |
|---------|--------|------|------|------|
| 签名 | `sign` | String | Y | MD5签名 |
| 签名方式 | `signType` | String | Y | 固定 `MD5` |
| 访问时间戳 | `timestamp` | String | Y | 格式：`yyyyMMddHHmmss` |
| 京东订单号 | `jdOrderNo` | Long | Y | 唯一流水号 |

**返回参数**：与 beginDistill 返回结构一致（sign、signType、timestamp、code、jdOrderNo、agentOrderNo、produceStatus、product）。

**特殊说明**：反查返回生产中（produceStatus=3）时，京东会继续反查直到超过次数上限，之后仅依赖回调。

#### 2.3.3 回调通知（/produce/result）

**请求方向**：我方 → 京东  
**请求方式**：HTTP POST  
**Content-Type**：`application/x-www-form-urlencoded`

**回调地址：**

| 环境 | 地址 |
|------|------|
| 测试环境 | `https://tsp.shop.jd.com/vtp/produce/notify` |
| 线上环境 | `{notifyUrl}/produce/result`（notifyUrl 在 beginDistill 入参中下发） |

> ⚠️ **注意**：测试期间严禁调用线上回调接口！

**请求参数：**

| 字段名称 | 变量名 | 类型 | 必填 | 说明 |
|---------|--------|------|------|------|
| 签名 | `sign` | String | Y | MD5签名 |
| 访问时间戳 | `timestamp` | String | Y | 格式：`yyyyMMddHHmmss` |
| 代理商ID | `vendorId` | String | Y | 京东分配的ID |
| 京东订单号 | `jdOrderNo` | Long | Y | 京东订单号 |
| 代理商订单号 | `agentOrderNo` | String | Y | 我方订单号 |
| 订单状态 | `produceStatus` | Integer | Y | 充值结果（1=成功, 2=失败） |
| 数量 | `quantity` | Integer | Y | 直充购买数量只能为1 |
| 卡密信息 | `product` | String | N | AES 加密后的卡密JSON数组 |

**京东返回：**

| 字段名称 | 变量名 | 类型 | 说明 |
|---------|--------|------|------|
| 错误码 | `code` | String | 0=成功 |
| 错误信息 | `message` | String | 失败时的错误信息 |

**回调错误码：**

| 错误码 | 说明 |
|--------|------|
| 0 | 成功 |
| 2 | 参数校验错误 |
| 3 | 订单不存在 |
| 10 | 签名校验错误 |
| 11 | IP没有权限 |
| 12 | 数量错误 |
| 13 | 订单状态错误 |
| 19 | 商家不存在 |
| 500 | 系统异常 |

### 2.4 通用交易签名示例

**签名计算步骤**：
1. 收集所有参数（排除 `sign`、`signType`）
2. 按 key 字母升序排序
3. 拼接为 `key1=value1&key2=value2&...&PRIVATEKEY`
4. 对拼接字符串做 MD5，取 32 位小写 hex

**示例**：
```
原始参数：{jdOrderNo: 10001, timestamp: "20210207170426"}
PRIVATEKEY: abc123...

排序拼接：jdOrderNo=10001&timestamp=20210207170426&abc123...
签名结果：md5("jdOrderNo=10001&timestamp=20210207170426&abc123...")
```

### 2.5 卡密 AES 加密示例

```
加密前：[{"cardNumber":"123456","expiryDate":"2016-10-10","password":"654321"},...]
密钥：12345678901234567890123456789012（32字节）
加密模式：AES-256 / ECB / PKCS5Padding
加密后：QZltw6QjIQ55tmU0xg2+20FGGnnmGoTWN/KZUdsllLo...（Base64编码的密文）
```

---

## 3. 京东游戏点卡平台接口分析

### 3.1 技术规范

| 项目 | 说明 |
|------|------|
| **请求格式** | HTTP POST（京东→我方）；POST 或 GET（我方→京东回调） |
| **编码** | UTF-8（常规）；**GBK**（回调 data 的 Base64 编码时） |
| **数据格式** | 外层为协议参数，`data` 字段为业务 JSON 的 Base64 编码值 |
| **加密方式** | Base64 编码业务数据；iTunes 场景使用 AES 加密 |
| **签名方式** | MD5：`key1=value1&key2=value2&...&privatekey`（key 升序排列），32 位小写 hex |
| **性能要求** | 提单校验 ≤ 400ms，接单接口 tp99 ≤ 1000ms，TPS ≥ 10 |

### 3.2 接口清单

#### 商家系统实现接口（京东调我方）

| 编号 | 接口名称 | 说明 | 性能要求 |
|------|---------|------|---------|
| 1 | 提单校验接口 | 提单前校验商品是否可售 | 平均 ≤ 200ms，最长 ≤ 400ms |
| 2 | 直充接单接口 | 接收直充订单 | tp99 ≤ 1000ms |
| 3 | 直充订单查询 | 查询直充订单状态 | tp99 ≤ 1000ms |
| 4 | 卡密接单接口 | 接收卡密订单 | tp99 ≤ 1000ms |
| 5 | 卡密订单查询 | 查询卡密订单状态（含卡密） | tp99 ≤ 1000ms |
| 6 | 身份价接口 | 校验品牌新人等身份标签 | — |
| 7 | 获取游戏账户信息 | 选号模式查询（仅游戏售卖） | ≤ 200ms |

#### 京东提供接口（我方调京东）

| 编号 | 接口名称 | 正式环境地址 | 测试环境地址 |
|------|---------|------------|------------|
| 1 | 直充回调 | `https://card.jd.com/api/gameApi.action` | `https://card-pre.jd.com/api/gameApi.action` |
| 2 | 卡密回调 | `https://card.jd.com/api/cardApi.action` | — |

### 3.3 公共请求参数（京东→我方 所有接口通用）

| 参数 | 含义 | 类型 | 必填 | 备注 |
|------|------|------|------|------|
| `customerId` | 合作商编号 | Long | Y | 京东提供 |
| `data` | 业务数据 | String | Y | `base64(JSON)` |
| `timestamp` | 时间戳 | String | Y | 格式：`yyyyMMddHHmmss` |
| `sign` | MD5签名摘要 | String | Y | 见签名说明 |
| `version` | 接口版本 | String | N | 暂不使用 |

### 3.4 接口详细参数

#### 3.4.1 提单校验接口

**业务数据（data Base64解码后的JSON）：**

| 参数 | 含义 | 类型 | 必填 |
|------|------|------|------|
| `pin` | 用户pin | String | Y |
| `buyNum` | 购买数量 | Int | Y |
| `skuId` | 京东商品skuId | Long | Y |
| `brandId` | 京东游戏品牌ID | Long | Y |
| `userIp` | 用户IP | String | Y |
| `totalPrice` | 订单总价 | Double | Y |
| `gameAccount` | 游戏账号 | String | N |
| `permit` | 通行证 | String | N |
| `gameAccountType` | 账号类型 | JSON | N |
| `chargeType` | 充值类型 | JSON | N |
| `gameArea` | 游戏区 | JSON | N |
| `gameServer` | 游戏服 | JSON | N |

**返回数据：**
```json
{
  "retCode": "100",
  "retMessage": "成功",
  "data": "base64({\"status\": \"0\"})"
}
```
- `status`: 0=可售卖，其他=不可售卖

#### 3.4.2 直充接单接口

**业务数据（data Base64解码后的JSON）：**

| 参数 | 含义 | 类型 | 必填 |
|------|------|------|------|
| `orderId` | 京东订单号 | Long | Y |
| `pin` | 用户pin | String | N |
| `buyNum` | 购买数量 | Int | Y |
| `skuId` | 京东商品skuId | Long | Y |
| `brandId` | 品牌ID | Long | Y |
| `userIp` | 用户IP | String | N |
| `totalPrice` | 订单总价（商家应收款） | Double | Y |
| `jingBean` | 使用京豆金额 | Double | N |
| `coupons` | 使用优惠券金额 | Double | N |
| `gameAccount` | 游戏账号 | String | Y |
| `permit` | 通行证 | String | N |
| `gameAccountType` | 账号类型 | JSON | N |
| `chargeType` | 充值类型 | JSON | N |
| `gameArea` | 游戏区 | JSON | N |
| `gameServer` | 游戏服 | JSON | N |
| `address` | 收货地址 | JSON | N |
| `type` | 充值类型（0=正常, 1=赠品权益） | Int | N |
| `rights` | 赠品权益账户信息 | JSON数组 | N |
| `features` | 扩展字段 | JSON串 | N |
| `outId` | 外部商家商品编号 | String | N |
| `promotionPrice` | 促销后价格 | String | N |

**返回数据：**
```json
{
  "retCode": "100",
  "retMessage": "成功"
}
```
- retCode `100` = 接受订单成功（待充值）

#### 3.4.3 直充订单查询接口

**业务数据：**
```json
{"orderId": "1000005565"}
```

**返回数据：**
```json
{
  "retCode": "100",
  "retMessage": "查询成功",
  "data": "base64({\"orderStatus\": 0})"
}
```
- `orderStatus`: 0=充值成功, 1=充值中

#### 3.4.4 卡密接单接口

**业务数据（data Base64解码后的JSON）：**

| 参数 | 含义 | 类型 | 必填 |
|------|------|------|------|
| `orderId` | 京东订单号 | Long | Y |
| `pin` | 用户pin | String | N |
| `brandId` | 品牌ID | Long | Y |
| `skuId` | 京东商品skuId | Long | Y |
| `buyNum` | 购买数量 | Int | Y |
| `totalPrice` | 订单总价 | Double | Y |
| `features` | 扩展字段 | JSON | N |
| `userIp` | 用户IP | String | N |
| `tokenId` | 游戏售卖唯一ID | String | 游戏售卖必填 |
| `facePrice` | 面值 | Long | N |
| `sourceType` | 订单来源（0=主站, 1=惊喜） | Int | Y |
| `outId` | 外部商品编号 | String | N |

**iTunes 场景扩展字段（features 中 itunesFeature）：**

需将以下 JSON 使用 **AES 加密**（测试 key: `0789e8410e0b4ece99141aaf7273fda6`）：

| 参数 | 含义 | 必填 |
|------|------|------|
| `userPin` | 用户Pin | Y |
| `phoneNum` | 联系电话 | N |
| `email` | 联系邮件 | N |
| `address` | 联系地址 | N |
| `phoneNumVerified` | 是否完成手机验证(0/1) | Y |
| `realNameVerified` | 是否完成实名认证(0/1) | N |
| `payOrderIpRecorded` | 是否记录支付IP(0/1) | Y |

**返回数据（同步卡密）：**
```json
{
  "retCode": "100",
  "retMessage": "成功",
  "data": "base64({\"cardinfos\":[{\"cardno\":\"DXFD-XCV-000000814\",\"cardpass\":\"193-4343-32322814\",\"expiretime\":\"2008-12-01\"}]})"
}
```

**卡密元素说明：**

| 参数 | 含义 | 类型 | 必填 | 约束 |
|------|------|------|------|------|
| `cardno` | 卡号 | String | Y | ≤ 200 字节，仅支持字母、数字、-、_ |
| `cardpass` | 卡密密码 | String | Y | ≤ 5000 字节，仅支持 ASCII |
| `expiretime` | 过期时间 | String | N | 格式：`yyyy-MM-dd` |

#### 3.4.5 卡密订单查询接口

**业务数据：**
```json
{"orderId": "1000005565"}
```

**返回数据（成功含卡密）：**
```json
{
  "retCode": "100",
  "retMessage": "充值成功",
  "data": "base64({\"orderStatus\":\"0\",\"cardinfos\":[{\"cardno\":\"...\",\"cardpass\":\"...\",\"expiretime\":\"...\"}]})"
}
```

#### 3.4.6 直充回调接口（我方→京东）

**请求地址：**
- 正式环境：`https://card.jd.com/api/gameApi.action`
- 测试环境：`https://card-pre.jd.com/api/gameApi.action`

**请求方式**：GET 或 POST（POST 时 body 按 form 表单格式）

**请求参数：**

| 参数 | 含义 | 类型 | 必填 |
|------|------|------|------|
| `customerId` | 商家编号 | Long | Y |
| `data` | 业务数据（Base64） | String | Y |
| `timestamp` | 时间戳 | String | Y |
| `sign` | MD5签名 | String | Y |

**业务数据（data Base64 解码后，⚠️ 编码时需使用 GBK）：**

| 参数 | 含义 | 类型 | 必填 |
|------|------|------|------|
| `orderId` | 京东订单号 | Long | Y |
| `orderStatus` | 订单状态 | Int | Y |
| `type` | 充值类型（0=正常, 1=权益） | Int | N |
| `rightsId` | 权益ID | String | type=1时必填 |
| `failedCode` | 失败错误码 | Int | 失败时必填 |
| `failedReason` | 失败原因（≤30汉字） | String | 失败时必填 |

**京东返回：**
```json
{"retCode": "100", "retMessage": "接收成功"}
```

#### 3.4.7 卡密回调接口（我方→京东）

**请求地址：**
- 正式环境：`https://card.jd.com/api/cardApi.action`

**业务数据（⚠️ 编码时需使用 GBK）：**

| 参数 | 含义 | 类型 | 必填 |
|------|------|------|------|
| `orderId` | 京东订单号 | Long | Y |
| `orderStatus` | 订单状态 | Int | Y |
| `cardinfos` | 卡密组 | JSON数组 | 卡密订单必填 |
| `failedCode` | 失败错误码 | Int | 失败时必填 |
| `failedReason` | 失败原因 | String | 失败时必填 |

**京东返回：**
```json
{"retCode": "100", "retMessage": "接收成功"}
```

### 3.5 游戏点卡签名示例

**签名公式：**
```
sign = md5(customerId=10817&data=base64(data)&timestamp=20120424165458&privateKey)
```

**Python 示例：**
```python
import hashlib

def gensign(private_key, param_dict):
    param_urls = []
    for key in sorted(param_dict):
        param_urls.append(key + "=" + str(param_dict[key]))
    param_urls.append(private_key)
    param_url_str = "&".join(param_urls)
    md5lib = hashlib.md5()
    md5lib.update(param_url_str.encode('utf-8'))
    return md5lib.hexdigest()
```

### 3.6 订单状态枚举

| 代码 | 信息 |
|------|------|
| 0 | 充值成功 |
| 1 | 充值中 |

### 3.7 返回码信息

| 代码 | 信息 | 备注 |
|------|------|------|
| 100 | 成功/接收成功 | — |
| 101 | 订单不存在 | — |
| 102 | 订单号不允许重复 | — |
| 103 | 该游戏区服不存在或已暂停 | — |
| 104 | 传入的参数有误 | — |
| 105 | IP地址不符合要求 | [重试] |
| 106 | 验证摘要串验证失败 | [重试] |
| 107 | 没有对应商品 | — |
| 108 | 数据库繁忙 | [重试] |
| 109 | 本商品不可销售 | — |
| 110 | 库存不足 | [重试] |
| 111 | 商品价钱不一致 | — |
| 112 | 账户余额不足 | — |
| 113 | 角色或账号不存在 | — |
| 114 | 角色或账号验证失败 | — |
| 115 | 游戏品牌不存在 | — |
| 116 | 充值帐户输入错误 | — |
| 117 | 账号不匹配身份要求 | — |
| 118 | 账号达到最大购买次数限制 | — |
| 119 | 账号被风控 | — |
| 120 | 账号被封停 | — |
| 121 | 无该产品的购买资格 | — |
| 122 | 账号转换映射失败 | — |
| 123 | 品牌侧下单失败 | — |
| 124 | 非有效价格 | — |
| 999 | 系统错误 | [重试] |
| 1000 | 调用品牌方超时 | [重试] |

> 标记 **[重试]** 的错误码，京东会对查询接口进行重试。

---

## 4. 阿奇索开放平台接口分析

### 4.1 平台概述

阿奇索开放平台（`https://open.agiso.com`）提供自动发货能力，支持京东等多电商平台订单的自动拉取与发货履约。在本系统中作为**可选扩展模块**，按商户独立配置。

### 4.2 接入流程

1. **注册应用**：在阿奇索开放平台创建应用，获取 `AppId` 和 `AppSecret`
2. **店铺授权**：通过阿奇索授权页面绑定京东店铺，获取 `AccessToken`
3. **调用接口**：携带 Token 和签名调用 API

### 4.3 技术规范

| 项目 | 说明 |
|------|------|
| **请求格式** | HTTP POST |
| **编码** | UTF-8 |
| **认证方式** | Header: `Authorization: Bearer {access_token}` |
| **版本标识** | Header: `ApiVersion: 1` |
| **签名方式** | MD5：`md5(AppSecret + 参数名值拼接(ASCII升序) + AppSecret)`，结果转**大写** |

### 4.4 签名算法

**步骤：**
1. 将所有参数（排除 `sign` 本身和 `byte[]` 类型）按参数名 ASCII 升序排列
2. 将参数名和值直接拼接（无分隔符）：`key1value1key2value2...`
3. 在拼接内容**前后**各加上 `AppSecret`
4. 对完整字符串做 MD5，结果转大写

**示例：**
```python
import hashlib

def get_sign(data, app_secret):
    param_list = [f"{k}{v}" for k, v in sorted(data.items())]
    joined = ''.join(param_list)
    raw = f"{app_secret}{joined}{app_secret}"
    return hashlib.md5(raw.encode('utf-8')).hexdigest().upper()
```

### 4.5 核心接口（推测）

> 以下基于阿奇索公开文档和通用自动发货平台模式，具体路由以实际文档为准。

| 接口功能 | 调用方向 | 说明 |
|---------|---------|------|
| 订单拉取 | 我方 → 阿奇索 | 拉取待发货的京东订单列表 |
| 自动发货 | 我方 → 阿奇索 | 提交发货信息（卡密/充值结果） |
| 发货状态查询 | 我方 → 阿奇索 | 查询发货结果 |
| 商品库存查询 | 我方 → 阿奇索 | 查询可用商品库存 |

### 4.6 配置参数（按商户隔离）

| 配置项 | 说明 | 加密存储 |
|--------|------|---------|
| `host` | 阿奇索API网关地址 | N |
| `port` | 端口 | N |
| `appId` | 应用ID | N |
| `appSecret` | 应用密钥 | **Y** |
| `accessToken` | 授权令牌 | **Y** |
| `generalTradeRoute` | 通用交易路由 | N |
| `gameCardRoute` | 点卡路由 | N |
| `enabled` | 启用开关 | N |

### 4.7 集成规则

1. **不配置不影响主流程**：未配置阿奇索的商户，订单页"阿奇索自动发货"按钮置灰/隐藏
2. **不报错不阻塞**：未配置时不加载相关代码，不产生任何错误日志
3. **按商户独立配置**：每个商户可独立设置阿奇索参数
4. **日志隔离**：阿奇索调用产生独立日志表（`agiso_logs`）

---

## 5. 三平台加密签名差异对比

| 维度 | 京东通用交易 | 京东游戏点卡 | 阿奇索开放平台 |
|------|------------|------------|--------------|
| **签名算法** | MD5 | MD5 | MD5 |
| **签名格式** | `key=value&` 拼接 + PRIVATEKEY | `key=value&` 拼接 + privatekey | `keyvalue` 拼接，前后加 AppSecret |
| **签名大小写** | 小写 hex | 小写 hex | **大写** hex |
| **Key 排序** | 字母升序 | 字母升序 | ASCII 升序 |
| **业务数据加密** | AES-256 ECB（卡密） | Base64（通用）；AES（iTunes） | 无额外加密 |
| **编码要求** | UTF-8 | UTF-8；回调 data 用 **GBK** Base64 | UTF-8 |
| **认证方式** | vendorId + 签名 | customerId + 签名 | Bearer Token + 签名 |
| **签名排除项** | sign、signType | sign（无值的参数不参与） | sign、byte[]类型 |

### 关键差异总结

1. **通用交易 vs 游戏点卡签名**：
   - 通用交易：`key1=value1&key2=value2&PRIVATEKEY`（最后直接拼接密钥，无 `&` 分隔）
   - 游戏点卡：`key1=value1&key2=value2&privatekey`（最后用 `&` 连接密钥）
   - 两者密钥拼接方式一致（末尾拼接），但通用交易的 sign/signType 不参与签名，游戏点卡是无值参数不参与

2. **GBK 编码**：仅游戏点卡的回调接口（gameApi.action / cardApi.action）的 data 字段需使用 GBK 编码后再 Base64

3. **阿奇索签名独特性**：参数名和值直接拼接（无 `=` 和 `&`），密钥包裹在首尾，结果取大写

---

## 6. 接口地址汇总与配置要求

### 6.1 我方需提供的接口地址（京东调用）

#### 通用交易

| 接口 | 我方地址格式 | 说明 |
|------|------------|------|
| 提交充值/提取卡密 | `https://{domain}/api/jd/general/beginDistill` | 接收京东生产请求 |
| 生产反查 | `https://{domain}/api/jd/general/findDistill` | 接收京东反查请求 |

#### 游戏点卡

| 接口 | 我方地址格式 | 说明 |
|------|------------|------|
| 直充接单 | `https://{domain}/api/jd/game/directCharge` | 接收直充订单 |
| 直充查询 | `https://{domain}/api/jd/game/directQuery` | 直充状态查询 |
| 卡券接单 | `https://{domain}/api/jd/game/cardOrder` | 接收卡密订单 |
| 卡券查询 | `https://{domain}/api/jd/game/cardQuery` | 卡密状态查询 |
| 提单校验 | `https://{domain}/api/jd/game/preCheck` | 商品可售校验 |

### 6.2 系统设置 — 店铺ID匹配接口地址

**核心需求**：系统设置页输入店铺ID（如 `11873018`），自动匹配展示我方接口地址，用于提交京东申请密钥。

**通用交易需要提交的地址：**
- 提交充值|提取卡密请求地址：`https://{domain}/api/jd/general/beginDistill`
- 反查充值|提取接口地址：`https://{domain}/api/jd/general/findDistill`

**游戏点卡需要提交的地址：**
- 直充接单接口地址：`https://{domain}/api/jd/game/directCharge`
- 直充查询接口地址：`https://{domain}/api/jd/game/directQuery`
- 卡券接单接口地址：`https://{domain}/api/jd/game/cardOrder`
- 卡券查询接口地址：`https://{domain}/api/jd/game/cardQuery`

### 6.3 京东提供的回调地址

| 业务 | 环境 | 地址 |
|------|------|------|
| 通用交易回调 | 测试 | `https://tsp.shop.jd.com/vtp/produce/notify` |
| 通用交易回调 | 线上 | `{notifyUrl}/produce/result` |
| 游戏点卡直充回调 | 正式 | `https://card.jd.com/api/gameApi.action` |
| 游戏点卡直充回调 | 测试 | `https://card-pre.jd.com/api/gameApi.action` |
| 游戏点卡卡密回调 | 正式 | `https://card.jd.com/api/cardApi.action` |

---

## 7. 错误码体系汇总

### 7.1 通用交易生产错误码

| 错误码 | 说明 |
|--------|------|
| `JDO_200` | 生产成功 |
| `JDO_201` | 生产中 |
| `JDO_301` | 生产账号错误 |
| `JDO_302` | 没有对应的商品 |
| `JDO_303` | 传入参数不正确 |
| `JDO_304` | 验证签名不正确 |
| `JDO_305` | 商品不可售 |
| `JDO_500` | 系统错误 |

### 7.2 通用交易生产状态

| 状态值 | 说明 |
|--------|------|
| 1 | 生产成功 |
| 2 | 生产失败（自动退款） |
| 3 | 生产中（需回调+反查） |
| 4 | 生产异常（暂停，等京东重试） |

### 7.3 通用交易回调错误码

| 错误码 | 说明 |
|--------|------|
| 0 | 成功 |
| 2 | 参数校验错误 |
| 3 | 订单不存在 |
| 10 | 签名校验错误 |
| 11 | IP没有权限 |
| 12 | 数量错误 |
| 13 | 订单状态错误 |
| 19 | 商家不存在 |
| 500 | 系统异常 |

### 7.4 游戏点卡返回码

见 [3.7 返回码信息](#37-返回码信息)

---

## 8. 数据库表设计建议

基于接口分析，建议的核心表结构：

### 8.1 商户京东配置表（merchant_jd_config）

```sql
CREATE TABLE merchant_jd_config (
    id              BIGINT PRIMARY KEY AUTO_INCREMENT,
    merchant_id     BIGINT NOT NULL COMMENT '商户ID',
    biz_type        TINYINT NOT NULL COMMENT '1=通用交易, 2=游戏点卡',
    -- 通用交易字段
    vendor_id       BIGINT COMMENT '京东vendorId（通用交易）',
    -- 游戏点卡字段
    customer_id     BIGINT COMMENT '京东customerId（游戏点卡）',
    -- 公共字段
    md5_secret      VARCHAR(255) COMMENT 'MD5签名密钥（AES加密存储）',
    aes_secret      VARCHAR(255) COMMENT 'AES加密密钥（AES加密存储）',
    our_api_url     VARCHAR(500) COMMENT '我方接口基础地址',
    jd_callback_url VARCHAR(500) COMMENT '京东回调地址',
    -- 游戏点卡特有
    jd_direct_callback_url VARCHAR(500) COMMENT '京东直充回调地址',
    jd_card_callback_url   VARCHAR(500) COMMENT '京东卡密回调地址',
    is_enabled      TINYINT DEFAULT 1 COMMENT '启用开关 0=禁用 1=启用',
    create_time     DATETIME DEFAULT CURRENT_TIMESTAMP,
    update_time     DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_merchant_biz (merchant_id, biz_type)
) COMMENT '商户京东配置表';
```

### 8.2 订单主表（orders）

```sql
CREATE TABLE orders (
    id              BIGINT PRIMARY KEY AUTO_INCREMENT,
    merchant_id     BIGINT NOT NULL COMMENT '商户ID',
    biz_type        TINYINT NOT NULL COMMENT '1=通用交易, 2=游戏点卡',
    order_no        VARCHAR(64) NOT NULL COMMENT '我方订单号',
    jd_order_no     VARCHAR(64) NOT NULL COMMENT '京东订单号',
    order_status    TINYINT NOT NULL COMMENT '订单状态',
    operation_mode  TINYINT DEFAULT 0 COMMENT '操作方式 0=自动 1=手动',
    amount          BIGINT COMMENT '订单金额（分）',
    quantity        INT COMMENT '数量',
    sku_id          VARCHAR(64) COMMENT '商品SKU',
    ware_no         VARCHAR(64) COMMENT '商品编码',
    produce_account VARCHAR(255) COMMENT '充值账号',
    product_info    TEXT COMMENT '卡密信息（加密存储）',
    notify_url      VARCHAR(500) COMMENT '回调地址',
    pay_time        DATETIME COMMENT '支付时间',
    remark          VARCHAR(500) COMMENT '备注',
    create_time     DATETIME DEFAULT CURRENT_TIMESTAMP,
    update_time     DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_jd_order_biz (jd_order_no, biz_type)
) COMMENT '订单主表';
```

### 8.3 京东回调记录表（jd_callbacks）

```sql
CREATE TABLE jd_callbacks (
    id              BIGINT PRIMARY KEY AUTO_INCREMENT,
    order_id        BIGINT NOT NULL COMMENT '订单ID',
    callback_type   TINYINT NOT NULL COMMENT '1=通用交易回调, 2=直充回调, 3=卡密回调',
    callback_direction TINYINT COMMENT '1=京东调我方, 2=我方调京东',
    request_params  TEXT COMMENT '请求参数（脱敏）',
    response_data   TEXT COMMENT '响应数据（脱敏）',
    result_code     VARCHAR(32) COMMENT '结果码',
    result_message  VARCHAR(500) COMMENT '结果信息',
    retry_count     INT DEFAULT 0 COMMENT '重试次数',
    create_time     DATETIME DEFAULT CURRENT_TIMESTAMP
) COMMENT '京东回调记录表';
```

---

## 9. 开发核心注意事项

### 9.1 幂等性要求

- **通用交易**：同一 `jdOrderNo` 多次调用 beginDistill，必须基于订单号防重，每次返回该订单结果
- **游戏点卡**：同一 `orderId` 不允许重复创建订单（返回码 102）
- **唯一键设计**：`jd_order_no + biz_type` 作为唯一约束

### 9.2 编码处理

- 通用交易全程 **UTF-8**
- 游戏点卡回调（gameApi.action / cardApi.action）的 `data` 字段需 **GBK 编码后 Base64**
- 接收京东回调时需按 GBK 解码 Base64 内容

### 9.3 加密存储

- 所有密钥（md5Secret、aesSecret、privateKey）：AES 加密存储
- 卡密信息（product/cardinfos）：AES 加密存储
- 前端展示：`******` 脱敏，Admin 二次验证后可查看
- 日志打印：禁止明文密钥

### 9.4 性能要求

| 接口 | 性能要求 |
|------|---------|
| 通用交易 beginDistill（同步） | tp999 ≤ 600ms |
| 游戏点卡 提单校验 | 平均 ≤ 200ms，最长 ≤ 400ms |
| 游戏点卡 接单/查询 | tp99 ≤ 1000ms |
| 游戏点卡 获取游戏账户 | ≤ 200ms |

### 9.5 可选模块规则

- 阿奇索自动发货：未配置不执行、不报错、按钮隐藏
- 订单通知（钉钉/微信）：未配置不推送、推送失败不影响订单流程
- 统计报表/定时任务：可选开发，不侵入主流程

### 9.6 安全要求

- 签名校验必须在接收京东请求时执行
- IP 白名单校验（通用交易回调错误码 11）
- 防重放攻击：校验 timestamp 时间戳误差
- AES 密钥 32 字节长度校验
- 所有数据库密码、API 密钥通过 `.env` 配置，不硬编码
