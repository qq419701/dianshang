# 京东电商平台管理系统 - 重构架构设计

## 一、系统概述

本系统用于管理京东游戏点卡和通用交易两种订单类型，支持直充和卡密两种发货方式，并支持钉钉/企业微信订单通知。

---

## 二、核心概念

### 1. 店铺（Shop）
- 每个店铺对应一个京东接口配置
- 店铺类型：游戏点卡店铺、通用交易店铺
- 店铺包含：店铺名称、接口配置、到期时间、启用状态、通知配置

### 2. 订单（Order）
- **游戏点卡订单**：直充订单、卡密订单
- **通用交易订单**：直充订单、卡密订单
- 每个订单关联一个店铺
- 新订单自动触发通知（根据店铺配置）

### 3. 用户（User）
- **超级管理员**：管理所有店铺、订单、用户
- **子账号**：只能查看授权店铺的订单，可操作发货/退款

### 4. 订单通知
- **钉钉通知**：通过钉钉机器人 Webhook 发送订单消息
- **企业微信通知**：通过企业微信机器人 Webhook 发送订单消息
- 通知内容：订单号、商品名称、金额、充值账号、时间

---

## 三、数据库设计

### 1. shops 表（店铺表）

```sql
CREATE TABLE shops (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    shop_name VARCHAR(100) NOT NULL COMMENT '店铺名称',
    shop_code VARCHAR(50) UNIQUE NOT NULL COMMENT '店铺代码',
    shop_type TINYINT NOT NULL COMMENT '店铺类型：1=游戏点卡 2=通用交易',

    -- 游戏点卡配置
    game_customer_id VARCHAR(50) COMMENT '游戏点卡客户ID',
    game_md5_secret VARCHAR(500) COMMENT '游戏点卡MD5密钥（加密存储）',
    game_direct_callback_url VARCHAR(500) COMMENT '游戏直充回调地址',
    game_card_callback_url VARCHAR(500) COMMENT '游戏卡密回调地址',
    game_api_url VARCHAR(500) COMMENT '游戏点卡接口地址',

    -- 通用交易配置
    general_vendor_id VARCHAR(50) COMMENT '通用交易商家ID',
    general_md5_secret VARCHAR(500) COMMENT '通用交易MD5密钥（加密存储）',
    general_aes_secret VARCHAR(500) COMMENT '通用交易AES密钥（加密存储）',
    general_callback_url VARCHAR(500) COMMENT '通用交易回调地址',
    general_api_url VARCHAR(500) COMMENT '通用交易接口地址',

    -- 阿奇索配置
    agiso_enabled TINYINT DEFAULT 0 COMMENT '是否启用阿奇索：0=否 1=是',
    agiso_host VARCHAR(100) COMMENT '阿奇索主机地址',
    agiso_port INT COMMENT '阿奇索端口',
    agiso_app_id VARCHAR(100) COMMENT '阿奇索应用ID',
    agiso_app_secret VARCHAR(500) COMMENT '阿奇索应用密钥（加密存储）',
    agiso_access_token VARCHAR(500) COMMENT '阿奇索访问令牌（加密存储）',

    -- 订单通知配置
    notify_enabled TINYINT DEFAULT 0 COMMENT '是否启用订单通知：0=否 1=是',
    dingtalk_webhook VARCHAR(500) COMMENT '钉钉机器人Webhook地址',
    dingtalk_secret VARCHAR(500) COMMENT '钉钉机器人加签密钥',
    wecom_webhook VARCHAR(500) COMMENT '企业微信机器人Webhook地址',

    -- 店铺状态
    is_enabled TINYINT DEFAULT 1 COMMENT '是否启用：0=禁用 1=启用',
    expire_time DATETIME COMMENT '到期时间',
    remark VARCHAR(500) COMMENT '备注',

    create_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    INDEX idx_shop_type (shop_type),
    INDEX idx_enabled (is_enabled)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='店铺表';
```

### 2. orders 表（订单表）

```sql
CREATE TABLE orders (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    order_no VARCHAR(64) UNIQUE NOT NULL COMMENT '我方订单号',
    jd_order_no VARCHAR(64) NOT NULL COMMENT '京东订单号',

    shop_id BIGINT NOT NULL COMMENT '店铺ID',
    shop_type TINYINT NOT NULL COMMENT '店铺类型：1=游戏点卡 2=通用交易',
    order_type TINYINT NOT NULL COMMENT '订单类型：1=直充 2=卡密',

    order_status TINYINT DEFAULT 0 COMMENT '订单状态：0=待支付 1=处理中 2=已完成 3=已取消',

    -- 订单信息
    sku_id VARCHAR(64) COMMENT '商品SKU',
    product_info TEXT COMMENT '商品信息',
    amount BIGINT NOT NULL COMMENT '金额（分）',
    quantity INT DEFAULT 1 COMMENT '数量',

    -- 充值信息（直充订单有，卡密订单无）
    produce_account VARCHAR(255) COMMENT '充值账号',

    -- 卡密信息（卡密订单有）
    card_info TEXT COMMENT '卡密信息JSON',

    -- 回调信息
    notify_url VARCHAR(500) COMMENT '回调地址',
    notify_status TINYINT DEFAULT 0 COMMENT '回调状态：0=未回调 1=成功 2=失败',
    notify_time DATETIME COMMENT '回调时间',

    -- 通知记录
    notified TINYINT DEFAULT 0 COMMENT '是否已发送通知：0=否 1=是',
    notify_send_time DATETIME COMMENT '通知发送时间',

    -- 时间信息
    pay_time DATETIME COMMENT '支付时间',
    deliver_time DATETIME COMMENT '发货时间',

    remark VARCHAR(500) COMMENT '备注',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    INDEX idx_jd_order (jd_order_no, shop_type),
    INDEX idx_shop (shop_id, order_status),
    INDEX idx_create_time (create_time),
    INDEX idx_notified (notified, create_time),

    FOREIGN KEY (shop_id) REFERENCES shops(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='订单表';
```

### 3. users 表（用户表）

```sql
CREATE TABLE users (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) UNIQUE NOT NULL COMMENT '用户名',
    password_hash VARCHAR(255) NOT NULL COMMENT '密码哈希',
    name VARCHAR(100) COMMENT '姓名',

    role ENUM('admin', 'operator') NOT NULL DEFAULT 'operator' COMMENT '角色：admin=管理员 operator=操作员',

    -- 权限配置
    can_view_order TINYINT DEFAULT 1 COMMENT '查看订单权限',
    can_deliver TINYINT DEFAULT 0 COMMENT '发货权限',
    can_refund TINYINT DEFAULT 0 COMMENT '退款权限',

    is_active TINYINT DEFAULT 1 COMMENT '是否激活',
    last_login DATETIME COMMENT '最后登录时间',

    create_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    INDEX idx_username (username)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户表';
```

### 4. user_shop_permissions 表（用户店铺权限表）

```sql
CREATE TABLE user_shop_permissions (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL COMMENT '用户ID',
    shop_id BIGINT NOT NULL COMMENT '店铺ID',

    create_time DATETIME DEFAULT CURRENT_TIMESTAMP,

    UNIQUE KEY uk_user_shop (user_id, shop_id),
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (shop_id) REFERENCES shops(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户店铺权限表';
```

### 5. notification_logs 表（通知日志表）

```sql
CREATE TABLE notification_logs (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    order_id BIGINT NOT NULL COMMENT '订单ID',
    shop_id BIGINT NOT NULL COMMENT '店铺ID',

    notify_type ENUM('dingtalk', 'wecom') NOT NULL COMMENT '通知类型',
    notify_status TINYINT DEFAULT 0 COMMENT '通知状态：0=失败 1=成功',

    request_data TEXT COMMENT '请求数据',
    response_data TEXT COMMENT '响应数据',
    error_message TEXT COMMENT '错误信息',

    create_time DATETIME DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_order (order_id),
    INDEX idx_shop (shop_id),
    INDEX idx_create_time (create_time),

    FOREIGN KEY (order_id) REFERENCES orders(id) ON DELETE CASCADE,
    FOREIGN KEY (shop_id) REFERENCES shops(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='通知日志表';
```

---

## 四、业务流程

### 1. 订单创建流程（含通知）

```
接收京东订单请求
  ↓
创建订单记录
  ↓
判断店铺是否启用通知
  ↓
是：发送钉钉/企业微信通知
  ↓
记录通知日志
  ↓
返回订单创建结果
```

### 2. 直充订单发货流程

```
用户点击"通知成功"
  ↓
更新订单状态为"已完成"
  ↓
调用京东回调接口通知充值成功
  ↓
记录回调结果
```

### 3. 卡密订单发货流程

```
用户点击"发货"
  ↓
弹窗：输入卡密信息（根据数量动态生成输入框）
  例如：数量=3，则显示3组输入框
  [卡号1] [密码1]
  [卡号2] [密码2]
  [卡号3] [密码3]
  ↓
提交卡密数据
  ↓
更新订单状态为"已完成"
  ↓
调用京东回调接口传递卡密信息
  ↓
记录回调结果
```

### 4. 阿奇索自动发货流程

```
用户点击"阿奇索发货"
  ↓
调用阿奇索开放平台接口
  ↓
阿奇索返回：直充结果 or 卡密信息
  ↓
更新订单状态
  ↓
调用京东回调接口
  ↓
记录结果
```

### 5. 自助联调流程

```
用户点击"自助联调"
  ↓
展开下拉选项：
  - 充值成功
  - 充值中
  - 充值失败
  ↓
显示警告弹窗：
  ⚠️ 自助联调修改订单状态，非联调场景下，不要使用此功能。
  此页面是为了方便联调测试使用的，会直接修改订单状态而不回调
  京东官方，用于京东反查订单状态的场景，请确认清楚操作再点击
  确认按钮。
  ↓
用户确认
  ↓
直接修改订单状态（不触发回调）
  - 充值成功 → order_status = 2
  - 充值中 → order_status = 1
  - 充值失败 → order_status = 3
```

---

## 五、通知功能详细设计

### 1. 钉钉通知

**配置项：**
- Webhook地址：`https://oapi.dingtalk.com/robot/send?access_token=xxx`
- 加签密钥：用于签名验证（可选）

**消息格式（Markdown）：**

```markdown
### 📦 新订单通知

**订单号：** JD20260218123456
**店铺：** 游戏点卡店铺01
**商品：** 王者荣耀点券100元
**金额：** ¥100.00
**数量：** 1
**充值账号：** 13800138000
**创建时间：** 2026-02-18 14:30:25

> 请及时处理订单
```

**发送接口：**

```python
import hmac
import hashlib
import base64
import time
import urllib.parse
import requests

def send_dingtalk_notification(webhook, secret, message):
    timestamp = str(round(time.time() * 1000))
    sign = generate_sign(timestamp, secret)

    url = f"{webhook}&timestamp={timestamp}&sign={sign}"

    data = {
        "msgtype": "markdown",
        "markdown": {
            "title": "新订单通知",
            "text": message
        }
    }

    response = requests.post(url, json=data)
    return response.json()

def generate_sign(timestamp, secret):
    string_to_sign = f"{timestamp}\n{secret}"
    hmac_code = hmac.new(
        secret.encode('utf-8'),
        string_to_sign.encode('utf-8'),
        digestmod=hashlib.sha256
    ).digest()
    return urllib.parse.quote_plus(base64.b64encode(hmac_code).decode('utf-8'))
```

### 2. 企业微信通知

**配置项：**
- Webhook地址：`https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxx`

**消息格式（Markdown）：**

```markdown
### 📦 新订单通知

**订单号：** JD20260218123456
**店铺：** 游戏点卡店铺01
**商品：** 王者荣耀点券100元
**金额：** ¥100.00
**数量：** 1
**充值账号：** 13800138000
**创建时间：** 2026-02-18 14:30:25

> 请及时处理订单
```

**发送接口：**

```python
import requests

def send_wecom_notification(webhook, message):
    data = {
        "msgtype": "markdown",
        "markdown": {
            "content": message
        }
    }

    response = requests.post(webhook, json=data)
    return response.json()
```

### 3. 通知触发时机
- ✅ 新订单创建时（接收到京东订单）
- ✅ 订单状态变更时（可选，在店铺配置中设置）

### 4. 通知重试机制
- 失败自动重试3次
- 重试间隔：1秒、3秒、5秒
- 记录所有通知日志

---

## 六、权限控制

### 超级管理员权限
- ✅ 店铺管理（增删改查、配置通知）
- ✅ 订单管理（查看所有店铺订单、发货、退款、自助联调）
- ✅ 统计报表（所有店铺数据）
- ✅ 用户管理（创建子账号、分配权限）
- ✅ 通知日志查看

### 子账号权限
- ✅ 订单管理（仅查看授权店铺订单）
- ✅ 操作发货（如有权限）
- ✅ 退款操作（如有权限）
- ✅ 自助联调（需权限）
- ❌ 其他菜单全部隐藏

---

## 七、页面设计

### 1. 导航菜单

**管理员看到：**
- 🏪 店铺管理
- 📦 订单管理
- 📊 统计报表
- 👥 用户管理
- 🔔 通知日志（新增）

**子账号看到：**
- 📦 订单管理（仅此一项）

### 2. 店铺管理页面

**店铺列表：**

| 店铺名称 | 店铺类型 | 状态 | 到期时间 | 通知状态 | 操作 |
|---------|---------|------|---------|---------|------|
| 游戏点卡店01 | 游戏点卡 | 启用 | 2026-12-31 | 🔔已启用 | 编辑/删除 |

**编辑店铺 - 通知配置区：**

```
┌─────────────────────────────────┐
│ 📢 订单通知配置                  │
├─────────────────────────────────┤
│ □ 启用订单通知                   │
│                                  │
│ 钉钉通知：                       │
│ Webhook地址: [_______________]  │
│ 加签密钥: [_______________]     │
│ [测试发送]                       │
│                                  │
│ 企业微信通知：                   │
│ Webhook地址: [_______________]  │
│ [测试发送]                       │
└─────────────────────────────────┘
```

### 3. 订单管理页面

**筛选条件：**
- 店铺下拉选择
- 店铺类型（游戏点卡/通用交易）
- 订单类型（直充/卡密）
- 订单状态
- 时间范围
- 京东订单号搜索

**表格列：**

| 京东订单号 | 商品名称 | 店铺 | 业务类型 | 订单状态 | 金额 | 数量 | 充值账号 | 创建时间 | 操作 |
|-----------|---------|------|---------|---------|------|------|---------|---------|------|
| JD20260218001 | 王者荣耀点券 | 游戏店01 | 直充 | 处理中 | 100元 | 1 | 13800138000 | 02-18 14:30 | [按钮组] |

**注意：**
- 卡密订单充值账号显示为 `-`
- 列宽度优化，避免过宽

**操作按钮（下拉菜单样式）：**

```
[📄 详情] [通知成功 ▼]
              ├─ ✅ 通知成功（默认）
              ├─ 💰 通知退款
              ├─ 🚚 阿奇索发货（如有）
              └─ 🔧 自助联调 ▼
                    ├─ ⚠️ 充值成功
                    ├─ ⚠️ 充值中
                    └─ ⚠️ 充值失败
```

### 4. 通知日志页面（新增）

**筛选条件：**
- 店铺选择
- 通知类型（钉钉/企业微信）
- 通知状态（成功/失败）
- 时间范围

**表格列：**

| 订单号 | 店铺 | 通知类型 | 状态 | 发送时间 | 错误信息 | 操作 |
|-------|------|---------|------|---------|---------|------|
| JD001 | 店01 | 钉钉 | ✅成功 | 14:30:25 | - | 查看详情 |
| JD002 | 店02 | 企业微信 | ❌失败 | 14:31:10 | 网络超时 | 重新发送 |

---

## 八、接口设计

### 1. 京东回调接口

**游戏点卡直充成功回调：**

```http
POST {game_direct_callback_url}
Content-Type: application/json

{
  "jdOrderId": "JD20260218123456",
  "status": "SUCCESS",
  "message": "充值成功"
}
```

**游戏点卡卡密回调：**

```http
POST {game_card_callback_url}
Content-Type: application/json

{
  "jdOrderId": "JD20260218123456",
  "cards": [
    {"cardNo": "1234567890", "cardPwd": "abc123"},
    {"cardNo": "0987654321", "cardPwd": "def456"}
  ]
}
```

**通用交易回调（类似游戏点卡）**

### 2. 阿奇索接口

（根据阿奇索实际文档对接）

### 3. 内部API接口

**发送测试通知：**

```http
POST /api/shop/test-notification
Content-Type: application/json

{
  "shop_id": 1,
  "notify_type": "dingtalk"  // 或 "wecom"
}

Response:
{
  "success": true,
  "message": "测试通知发送成功"
}
```

**重新发送通知：**

```http
POST /api/notification/resend
Content-Type: application/json

{
  "log_id": 123
}
```

---

## 九、技术栈

### 后端
- Python 3.11+
- Flask 2.x
- SQLAlchemy（ORM）
- PyMySQL
- requests（HTTP请求）
- APScheduler（定时任务）

### 前端
- HTML5 + CSS3
- JavaScript（原生）
- Jinja2 模板引擎

### 数据库
- MySQL 8.0+

### 部署
- Supervisor（进程管理）
- Nginx（反向代理）

---

## 十、开发计划

### 第一阶段：数据库与模型（1天）
- ✅ 创建新的数据库表结构
- ✅ 编写数据模型
- ✅ 数据迁移脚本

### 第二阶段：权限系统（1天）
- ✅ 用户认证
- ✅ 角色权限控制
- ✅ 店铺权限分配

### 第三阶段：店铺管理（1天）
- ✅ 店铺CRUD
- ✅ 接口配置
- ✅ 通知配置

### 第四阶段：订单管理（2天）
- ✅ 订单列表
- ✅ 直充发货
- ✅ 卡密发货
- ✅ 自助联调
- ✅ 阿奇索发货

### 第五阶段：通知功能（1天）
- ✅ 钉钉通知
- ✅ 企业微信通知
- ✅ 通知日志
- ✅ 测试发送

### 第六阶段：统计报表（1天）
- ✅ 店铺统计
- ✅ 订单统计
- ✅ 图表展示

### 第七阶段：测试与优化（1天）
- ✅ 功能测试
- ✅ 性能优化
- ✅ 文档完善
